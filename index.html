<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiftsMine üéÅ</title>
<style>
/* –∫–∞—Å—Ç–æ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç (–ø–æ–ª–æ–∂–∏ minecraft.ttf –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞) */
@font-face { font-family: 'Minecraft'; src: url('minecraft.ttf') format('truetype'); font-weight: normal; font-style: normal; }

/* –±–∞–∑–æ–≤–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è */
html,body{height:100%;margin:0;padding:0;font-family:'Minecraft',Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#000;color:#fff;display:flex;flex-direction:column;overflow:hidden}
#balance{padding:15px;text-align:right;font-size:1.15rem;font-weight:700;background:rgba(0,0,0,0.15);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:900}
main{flex:1;overflow-y:auto;padding:12px;margin-bottom:60px;display:none;background: rgba(0,0,0,0.12)}
main.active{display:block}

/* —Ç–∞–±–±–∞—Ä */
.tab-bar{position:fixed;bottom:0;left:0;right:0;height:auto;display:flex;justify-content:space-around;background:rgba(0,0,0,0.18);padding:10px;border-top:2px solid #fff;z-index:1000}
.tab-bar button{flex:1;margin:0 6px;padding:10px;border:none;background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#fff;font-weight:700;cursor:pointer;border-radius:8px;transition:all .22s}
.tab-bar button.active{background:linear-gradient(135deg,#a1c4fd,#c2e9fb)}

/* –≥—Ä–∏–¥—ã */
.grid{display:grid;gap:8px;justify-content:center}
.mines-grid{grid-template-columns:repeat(5,minmax(50px,1fr))}
#mineGrid{grid-template-columns:repeat(4,minmax(60px,1fr));}

/* –∫–ª–µ—Ç–∫–∏ / –±–ª–æ–∫–∏ */
.mine-cell, .block{aspect-ratio:1/1;background:#333;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;position:relative;overflow:hidden;background-size:cover;background-position:center;border-radius:8px}
.mine-cell.disabled{pointer-events:none;opacity:.55}
.mine-cell.revealed.safe{background:#4caf50}
.mine-cell.revealed.mine{background:#f44336}
.block-price{position:absolute;right:6px;bottom:6px;background:rgba(0,0,0,0.55);padding:4px 6px;border-radius:4px;font-size:.78rem;display:flex;gap:6px;align-items:center}

/* –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å–ø—Ä–∞–≤–∞ –≤–Ω–∏–∑—É */
.inventory-list{position:fixed;right:12px;bottom:70px;width:260px;max-height:60vh;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding:8px;z-index:1000}
.gift-item{display:flex;align-items:center;background:rgba(20,20,20,0.9);padding:8px;border-radius:8px;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
.gift-preview{width:56px;height:56px;flex:0 0 56px;border-radius:6px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center}
.gift-info{flex:1; font-size:0.95rem}
.gift-actions{display:flex;flex-direction:column;gap:6px}
.gift-actions button{padding:6px 8px;border-radius:6px;border:none;background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#fff;cursor:pointer}

/* —Å—Ç–∞–≤–∫–∞ / –∫–Ω–æ–ø–∫–∏ */
.stake-options{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
#mineReward{border:2px dashed rgba(255,255,255,0.22);padding:10px;border-radius:10px;min-width:160px;text-align:center}
#collectReward{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#fff;cursor:pointer}

/* –ª–æ–∞–¥–µ—Ä */
#loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:2000;transition:opacity .45s}
#loader.hidden{opacity:0;pointer-events:none}
#loaderAnimation{width:160px;height:160px;margin-bottom:14px}
#progressContainer{width:70%;height:18px;background:#222;border-radius:12px;overflow:hidden}
#progressBar{height:100%;width:0;background:linear-gradient(90deg,#ff9a9e,#fad0c4);transition:width .15s}

/* –ª–µ—Ç–∞—é—â–∏–π –ø–æ–¥–∞—Ä–æ–∫ */
.flying{position:fixed;width:88px;height:88px;pointer-events:none;z-index:2500;left:0;top:0}

/* –º–æ–±—ã */
.mobs-grid{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
.mob-card{background:rgba(20,20,20,0.9);padding:10px;border-radius:10px;min-width:120px;text-align:center;cursor:pointer}
.mob-card img{width:72px;height:72px;object-fit:contain}
.mob-card.active{box-shadow:0 0 0 3px rgba(255,215,0,0.25);transform:translateY(-4px)}

/* —Ä—É–ª–µ—Ç–∫–∞ */
#rouletteCanvas{display:block;margin:8px auto;border-radius:50%;background:rgba(0,0,0,0.3);box-shadow:0 10px 30px rgba(0,0,0,0.4)}

/* responsive */
@media (max-width:560px){
  .inventory-list{width:200px;right:8px;bottom:70px}
  #rouletteCanvas{width:320px;height:320px}
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div id="loaderAnimation"></div>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <p style="color:#fff;margin-top:12px">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>
</div>

<!-- BALANCE -->
<div id="balance">–ë–∞–ª–∞–Ω—Å: 10000 <img src="ton.svg" style="width:16px;vertical-align:middle"></div>

<!-- MAIN VIEWS -->
<main id="menu" class="active">
  <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
  <p>–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø–æ–¥–∞—Ä–∫–∏!</p>
</main>

<!-- MINES -->
<main id="mines">
  <h2>–ú–∏–Ω—ã üí£</h2>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px">
    <div class="stake-options">
      <label><input type="radio" name="stakeType" value="ton" checked onchange="updateStakeInput()"> TON</label>
      <label><input type="radio" name="stakeType" value="gift" onchange="updateStakeInput()"> –ü–æ–¥–∞—Ä–æ–∫</label>
      <input type="number" id="tonStake" min="0.5" step="0.1" placeholder="–°—Ç–∞–≤–∫–∞ TON">
      <select id="giftStake" style="display:none"></select>
      <button onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
    </div>
    <div>
      <div id="mineReward">–í—ã–∏–≥—Ä—ã—à: ‚Äì</div>
      <button id="collectReward" onclick="collectReward()">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
  </div>
  <div class="grid mines-grid" id="minesGrid"></div>
  <p id="minesStatus"></p>
</main>

<!-- MINE (—à–∞—Ö—Ç–∞) -->
<main id="mine">
  <h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
  <div class="grid" id="mineGrid"></div>
</main>

<!-- MOBS -->
<main id="mobs">
  <h2>–ú–æ–±—ã üêæ</h2>
  <div class="mobs-grid" id="mobsGrid"></div>
  <canvas id="rouletteCanvas" width="420" height="420"></canvas>
  <div style="text-align:center;margin-top:8px">
    <button id="spinButton">–†–∞—Å–∫—Ä—É—Ç–∏—Ç—å</button>
  </div>
</main>

<!-- INVENTORY (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª) -->
<aside class="inventory-list" id="inventoryList"></aside>

<!-- TAB BAR -->
<div class="tab-bar">
  <button onclick="showTab('menu')" id="tab-menu" class="active">–ú–µ–Ω—é</button>
  <button onclick="showTab('mines')" id="tab-mines">–ú–∏–Ω—ã</button>
  <button onclick="showTab('mine')" id="tab-mine">–®–∞—Ö—Ç–∞</button>
  <button onclick="showTab('mobs')" id="tab-mobs">–ú–æ–±—ã</button>
  <button onclick="showTab('inventory')" id="tab-inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
</div>

<!-- Lottie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script>
/* ============================
   –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   ============================ */

/* --- Lottie –ª–æ–∞–¥–µ—Ä --- */
const loaderAnim = lottie.loadAnimation({
  container: document.getElementById('loaderAnimation'),
  renderer: 'svg', loop: true, autoplay: true,
  path: 'animations/myLoader.json' // —Ñ–∞–π–ª –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–æ–∞–¥–µ—Ä–∞
});

/* --- –ë–∞–ª–∞–Ω—Å –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ --- */
let balance = 10000;
function updateBalance(){
  document.getElementById('balance').innerHTML = `–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} <img src="ton.svg" style="width:16px;vertical-align:middle">`;
}

/* --- –í–∫–ª–∞–¥–∫–∏ –∏ —Ñ–æ–Ω --- */
const backgrounds = {
  menu:'images/menu.jpg',
  mines:'images/mines.jpg',
  mine:'images/mine.jpg',
  mobs:'images/mobs.jpg',
  inventory:'images/inventory.jpg'
};
function showTab(id){
  document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
  const tb = document.getElementById('tab-'+id);
  if(tb) tb.classList.add('active');
  // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Ñ–æ–Ω (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
  if(backgrounds[id]){
    document.body.style.backgroundImage = `url(${backgrounds[id]})`;
  }
  if(id==='inventory') renderInventory();
  if(id==='mobs') renderMobs();
}

/* --- –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ --- */
const gifts = [
  {name:"Hypno Lollipop",price:1.77},{name:"Desk Calendar",price:1.31},{name:"B-Day Candle",price:1.32},{name:"Lol Pop",price:1.32},
  {name:"Lunar Snake",price:1.38},{name:"Snake Box",price:1.36},{name:"Xmas Stocking",price:1.38},{name:"Whip Cupcake",price:1.38},
  {name:"Candy Cane",price:1.48},{name:"Pet Snake",price:1.58},{name:"Jester Hat",price:1.62},{name:"Snoop Dogg",price:1.64},
  {name:"Homemade Cake",price:1.7},{name:"Holiday Drink",price:1.7},{name:"Jingle Bells",price:1.74},{name:"Cookie Heart",price:1.75},
  {name:"Big Year",price:1.78},{name:"Party Sparkler",price:1.8},{name:"Winter Wreath",price:1.79},{name:"Swag Bag",price:1.91},
  {name:"Tama Gadget",price:1.93},{name:"Ginger Cookie",price:1.95},{name:"Moon Pendant",price:1.96},{name:"Jack-in-the-Box",price:2.01},
  {name:"Spiced Wine",price:2.12},{name:"Stellar Rocket",price:2.19},{name:"Star Notepad",price:2.32},{name:"Easter Egg",price:2.46},
  {name:"Restless Jar",price:2.5},{name:"Santa Hat",price:2.6},{name:"Snow Globe",price:2.65},{name:"Hex Pot",price:2.7},
  {name:"Joyful Bundle",price:2.71},{name:"Lush Bouquet",price:2.84},{name:"Witch Hat",price:2.86},{name:"Light Sword",price:3.13},
  {name:"Spy Agaric",price:3.2},{name:"Bow Tie",price:3.22},{name:"Eternal Candle",price:3.38},{name:"Bunny Muffin",price:3.34},
  {name:"Jelly Bunny",price:3.43},{name:"Berry Box",price:3.58},{name:"Evil Eye",price:3.6},{name:"Snow Mittens",price:3.67},
  {name:"Valentine Box",price:4.2},{name:"Snoop Cigar",price:4.26},{name:"Sakura Flower",price:4.77},{name:"Hanging Star",price:5.26},
  {name:"Jolly Chimp",price:5.34},{name:"Sleigh Bell",price:7.63},{name:"Skull Flower",price:7.7},{name:"Crystal Ball",price:7.86},
  {name:"Record Player",price:7.91},{name:"Love Candle",price:7.94},{name:"Top Hat",price:7.99},{name:"Trapped Heart",price:8.69},
  {name:"Love Potion",price:8.79},{name:"Flying Broom",price:9.45},{name:"Cupid Charm",price:11.26},{name:"Eternal Rose",price:13.71},
  {name:"Ionic Dryer",price:14.21},{name:"Diamond Ring",price:16.39},{name:"Voodoo Doll",price:16.43},{name:"Mad Pumpkin",price:17.91},
  {name:"Toy Bear",price:19.3},{name:"Vintage Cigar",price:23.98},{name:"Low Rider",price:24.8},{name:"Signet Ring",price:25.1},
  {name:"Neko Helmet",price:26.41},{name:"Electric Skull",price:31},{name:"Kissed Frog",price:34},{name:"Swiss Watch",price:35},
  {name:"Sharp Tongue",price:39.69},{name:"Scared Cat",price:43.6},{name:"Genie Lamp",price:47.07},{name:"Westside Sign",price:51.27},
  {name:"Bonded Ring",price:54.99},{name:"Gem Signet",price:72.98},{name:"Magic Potion",price:72.98},{name:"Ion Gem",price:83},
  {name:"Astral Shard",price:95.97},{name:"Perfume Bottle",price:95.99},{name:"Loot Bag",price:90.1},{name:"Mini Oscar",price:123.89},
  {name:"Nail Bracelet",price:129.84},{name:"Heroic Helmet",price:219.99},{name:"Precious Peach",price:379.99},{name:"Durov‚Äôs Cap",price:794.9},
  {name:"Heart Locket",price:1450},{name:"Plush Pepe",price:5199}
];

/* --- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å --- */
let inventory = [];
function renderInventory(){
  const list = document.getElementById('inventoryList');
  list.innerHTML = '';
  inventory.forEach((gift, idx) => {
    const div = document.createElement('div'); div.className = 'gift-item';
    const prev = document.createElement('div'); prev.className = 'gift-preview';
    // –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å lottie –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–µ–≤—å—é; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ
    try{
      lottie.loadAnimation({container: prev, renderer:'svg', loop:false, autoplay:true, path:`emoji/${gift.name}.json`});
    }catch(e){
      // –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–µ –ø—Ä–µ–≤—å—é
    }
    const info = document.createElement('div'); info.className='gift-info';
    info.innerHTML = `<strong>${gift.name}</strong><div style="font-size:0.85rem;color:#aaa">${gift.price} TON</div>`;
    const actions = document.createElement('div'); actions.className = 'gift-actions';
    const sell = document.createElement('button'); sell.textContent='–ü—Ä–æ–¥–∞—Ç—å'; sell.onclick = ()=>{
      balance += gift.price; updateBalance(); inventory.splice(idx,1); renderInventory();
    };
    const withdraw = document.createElement('button'); withdraw.textContent='–í—ã–≤–µ—Å—Ç–∏'; withdraw.onclick = ()=>{ alert('–í—ã–≤–æ–¥ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω'); };
    actions.appendChild(sell); actions.appendChild(withdraw);
    div.appendChild(prev); div.appendChild(info); div.appendChild(actions);
    list.appendChild(div);
  });
}

/* --- –®–∞—Ö—Ç–∞ (4x4) --- */
const oreTypes = [
  {img:"images/ores/coal.png",hits:3},
  {img:"images/ores/iron.png",hits:4},
  {img:"images/ores/gold.png",hits:5},
  {img:"images/ores/diamond.png",hits:6},
  {img:"images/ores/emerald.png",hits:7}
];

function getGiftByPrice(price,isFirst=false){
  let min = price * 0.5, max = price * 1.45;
  let possible = gifts.filter(g => g.price >= min && g.price <= max);
  if(isFirst){ possible = gifts.filter(g => g.price >= price); if(possible.length===0) possible=gifts; }
  if(possible.length===0) possible = gifts;
  return possible[Math.floor(Math.random()*possible.length)];
}

function spawnBlock(cell,index=0){
  const ore = oreTypes[Math.floor(Math.random()*oreTypes.length)];
  let price = +(1 + Math.random()*10).toFixed(2);
  cell.className = "block";
  cell.style.backgroundImage = `url(${ore.img})`;
  cell.innerHTML = `<div class="block-price">${price}<img src="ton.svg" style="width:12px;vertical-align:middle"></div>`;
  let hits = 0;
  cell.onclick = ()=>{
    hits++;
    if(hits >= ore.hits){
      if(balance >= price){ balance -= price; updateBalance(); }
      const gift = getGiftByPrice(price,index===0);
      inventory.push(gift); renderInventory();
      flyGift(gift,cell);
      let respawn = (60 + Math.random()*1740) * 1000;
      cell.classList.add('cooldown');
      cell.innerHTML = `<div style="position:absolute;top:6px;left:6px;font-size:0.8rem;color:#fff">${Math.round(respawn/60000)}m</div>`;
      cell.onclick = null;
      setTimeout(()=>{ cell.classList.remove('cooldown'); spawnBlock(cell,index); }, respawn);
    }
  };
}

function generateMineGrid(){
  const grid = document.getElementById('mineGrid');
  grid.innerHTML = '';
  for(let i=0;i<16;i++){
    const cell = document.createElement('div');
    spawnBlock(cell, i);
    grid.appendChild(cell);
  }
}

/* --- –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–µ—Ç–∞ –ø–æ–¥–∞—Ä–∫–∞ (lottie) --- */
function flyGift(gift, fromElem){
  const rect = fromElem.getBoundingClientRect();
  const fly = document.createElement('div'); fly.className='flying';
  fly.style.left = rect.left + 'px'; fly.style.top = rect.top + 'px';
  document.body.appendChild(fly);
  // –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é emoji/[name].json
  try{
    lottie.loadAnimation({container:fly, renderer:'svg', loop:false, autoplay:true, path:`emoji/${gift.name}.json`});
  }catch(e){
    // –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    fly.textContent = gift.name;
    fly.style.display = 'flex'; fly.style.alignItems='center'; fly.style.justifyContent='center'; fly.style.fontSize='12px';
  }
  const invRect = document.getElementById('inventoryList').getBoundingClientRect();
  const dx = (invRect.left + invRect.width/2) - rect.left;
  const dy = (invRect.top + invRect.height/2) - rect.top;
  fly.animate([{ transform: 'translate(0,0)', opacity:1 }, { transform: `translate(${dx}px, ${dy}px) scale(.6)`, opacity:0.9 }], { duration:1000, easing:'cubic-bezier(.22,.9,.35,1)' });
  setTimeout(()=>{ try{ fly.remove(); }catch(e){} }, 1100);
}

/* --- –ú–∏–Ω—ã (–º–∏–Ω–∏-–∏–≥—Ä–∞) --- */
let minesActive=false, minesLost=false, mineMultiplier=1, currentStake=0;

function generateMines(){
  const grid = document.getElementById('minesGrid'); grid.innerHTML='';
  let mines = [];
  while(mines.length < 5){
    let idx = Math.floor(Math.random()*25);
    if(!mines.includes(idx)) mines.push(idx);
  }
  for(let i=0;i<25;i++){
    const cell = document.createElement('div'); cell.className='mine-cell disabled';
    cell.dataset.mine = mines.includes(i) ? 'true' : 'false';
    cell.onclick = ()=> clickMine(cell);
    grid.appendChild(cell);
  }
}

function clickMine(cell){
  if(!minesActive || cell.classList.contains('revealed')) return;
  cell.classList.add('revealed');
  if(cell.dataset.mine === 'true'){
    cell.classList.add('mine');
    document.getElementById('minesStatus').innerText = 'üí• –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!';
    minesLost = true; minesActive = false;
  } else {
    cell.classList.add('safe');
    mineMultiplier += 0.5;
    document.getElementById('mineReward').innerText = '–í—ã–∏–≥—Ä—ã—à: ' + (currentStake * mineMultiplier).toFixed(2);
  }
}

function startMines(){
  const stakeType = document.querySelector('input[name="stakeType"]:checked').value;
  let stake = stakeType === 'ton' ? parseFloat(document.getElementById('tonStake').value) : null;
  if(stakeType === 'ton' && (!stake || isNaN(stake)){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É'); return; } )
  if(stakeType === 'ton' && balance < stake){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
  if(stakeType === 'ton') { balance -= stake; updateBalance(); }
  currentStake = stake; mineMultiplier = 1; minesLost = false; minesActive = true;
  generateMines(); document.querySelectorAll('.mine-cell').forEach(c=>c.classList.remove('disabled'));
  document.getElementById('mineReward').innerText = '–í—ã–∏–≥—Ä—ã—à: ‚Äì'; document.getElementById('minesStatus').innerText='';
}

function collectReward(){
  if(!minesActive && !minesLost && currentStake > 0){
    let win = currentStake * mineMultiplier;
    if(win >= 1.5){
      const gift = getGiftByPrice(win);
      inventory.push(gift); renderInventory();
      alert('–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫: ' + gift.name);
    } else {
      balance += win; updateBalance();
      alert('–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ' + win.toFixed(2) + ' TON');
    }
  }
  minesActive = false; currentStake = 0;
  document.getElementById('mineReward').innerText = '–í—ã–∏–≥—Ä—ã—à: ‚Äì';
}

/* --- –†–µ–Ω–¥–µ—Ä –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–±—ã (–Ω–æ–≤–∞—è –º–∏–Ω–∏-–∏–≥—Ä–∞) --- */
/* –î–∞–Ω–Ω—ã–µ –º–æ–±–æ–≤ (–∫–∞–∫ –≤—ã —É–∫–∞–∑–∞–ª–∏): –ó–æ–º–±–∏, –ü–∞—É–∫, –°–∫–µ–ª–µ—Ç, –ö—Ä–∏–ø–µ—Ä */
const mobsData = [
  { name:"–ó–æ–º–±–∏", price:1, lose:0.4, win:0.4, epicGift:"Restless Jar", color:"#0a5a0a", img:"mobs/–ó–æ–º–±–∏.png" },
  { name:"–ü–∞—É–∫", price:2, lose:0.3, win:0.6, epicGift:"Witch Hat", color:"#222222", img:"mobs/–ü–∞—É–∫.png" },
  { name:"–°–∫–µ–ª–µ—Ç", price:3, lose:0.9, win:0, epicGift:"Crystal Ball", color:"#aaaaaa", img:"mobs/–°–∫–µ–ª–µ—Ç.png" },
  { name:"–ö—Ä–∏–ø–µ—Ä", price:5, lose:0.7, win:0.25, epicGift:"Mad Pumpkin", color:"#3fa93f", img:"mobs/–ö—Ä–∏–ø–µ—Ä.png" }
];

let selectedMob = null;
let spinning = false;

/* canvas —Ä—É–ª–µ—Ç–∫–∏ */
const canvas = document.getElementById('rouletteCanvas');
const ctx = canvas.getContext('2d');
const C = { w: canvas.width, h: canvas.height, cx: canvas.width/2, cy: canvas.height/2, r: canvas.width/2 - 12 };

/* –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –º–æ–±–æ–≤ */
function renderMobs(){
  const grid = document.getElementById('mobsGrid');
  grid.innerHTML = '';
  mobsData.forEach(mob=>{
    const el = document.createElement('div'); el.className='mob-card';
    el.innerHTML = `<img src="${mob.img}" alt="${mob.name}" onerror="this.style.display='none'"><div style="margin-top:6px;font-weight:700">${mob.name}</div><div style="font-size:0.9rem;color:#ddd">${mob.price} TON</div>`;
    el.onclick = ()=> {
      // –≤—ã–±—Ä–∞–ª–∏ –º–æ–±–∞
      document.querySelectorAll('.mob-card').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      selectedMob = mob;
      drawRoulette(0);
    };
    grid.appendChild(el);
  });
}

/* –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä—É–ª–µ—Ç–∫–∏: 3 —Å–µ–∫—Ç–æ—Ä–∞ (–ø—Ä–æ–∏–≥—Ä—ã—à, –ø–æ–±–µ–¥–∞, —ç–ø–∏–∫) - —Ä–∞–∑–º–µ—Ä—ã –ø–æ —à–∞–Ω—Å–∞–º */
function drawRoulette(offsetAngle=0){
  ctx.clearRect(0,0,C.w,C.h);
  if(!selectedMob) {
    // –æ—Ç—Ä–∏—Å—É–µ–º —Å–µ—Ä—ã–π –∫—Ä—É–≥, –ø–æ–¥—Å–∫–∞–∑–∫—É
    ctx.fillStyle = '#222';
    ctx.beginPath(); ctx.arc(C.cx,C.cy,C.r,0,2*Math.PI); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font='16px Minecraft, Arial'; ctx.textAlign='center'; ctx.fillText('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–±–∞', C.cx, C.cy+6);
    return;
  }
  // —Å–æ—Å—Ç–∞–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
  const lose = selectedMob.lose;
  const win = selectedMob.win;
  const epic = Math.max(0, 1 - lose - win);
  const segs = [
    { label:'–ü—Ä–æ–∏–≥—Ä—ã—à', value:lose, color:'#f44336' },
    { label:'–í—ã–∏–≥—Ä—ã—à', value:win, color:selectedMob.color },
    { label:'–≠–ø–∏–∫', value:epic, color: lightenColor(selectedMob.color, 38) }
  ];
  // —Ä–∏—Å—É–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã
  let start = -Math.PI/2 + offsetAngle;
  segs.forEach(s=>{
    const sweep = s.value * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(C.cx, C.cy);
    ctx.arc(C.cx, C.cy, C.r, start, start + sweep);
    ctx.closePath();
    ctx.fillStyle = s.color;
    ctx.fill();
    // –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.lineWidth=2; ctx.stroke();
    // –ø–æ–¥–ø–∏—Å—å —Å–µ–∫—Ç–æ—Ä–∞
    const mid = start + sweep/2;
    const tx = C.cx + Math.cos(mid) * (C.r*0.65);
    const ty = C.cy + Math.sin(mid) * (C.r*0.65);
    ctx.fillStyle = '#000'; ctx.font='bold 14px Minecraft, Arial'; ctx.textAlign='center'; ctx.fillText(s.label, tx, ty+5);
    start += sweep;
  });
  // —Ü–µ–Ω—Ç—Ä: –∫–∞—Ä—Ç–∏–Ω–∫–∞ –º–æ–±–∞
  const img = new Image(); img.src = selectedMob.img;
  img.onload = ()=> {
    ctx.save();
    ctx.beginPath(); ctx.arc(C.cx,C.cy,46,0,2*Math.PI); ctx.closePath();
    ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fill();
    ctx.clip();
    ctx.drawImage(img, C.cx-46, C.cy-46, 92, 92);
    ctx.restore();
  };
}

/* –û—Å–≤–µ—Ç–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ (hex -> —Å–≤–µ—Ç–ª–µ–µ –Ω–∞ percent) */
function lightenColor(hex, percent){
  // hex like #112233
  if(!hex) return hex;
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  const num = parseInt(hex,16);
  let r = (num >> 16) + Math.round(2.55 * percent);
  let g = ((num >> 8) & 0xFF) + Math.round(2.55 * percent);
  let b = (num & 0xFF) + Math.round(2.55 * percent);
  r = Math.min(255, Math.max(0, r)); g = Math.min(255, Math.max(0, g)); b = Math.min(255, Math.max(0, b));
  return '#' + ( (1<<24) + (r<<16) + (g<<8) + b ).toString(16).slice(1);
}

/* –ü–†–û–ö–†–£–¢–ö–ê —Ä—É–ª–µ—Ç–∫–∏ ‚Äî –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—á—Ç–æ–±—ã —Å–µ–∫—Ç–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª –∏—Å—Ö–æ–¥—É) */
function spinRoulette(){
  if(!selectedMob) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–±–∞'); return; }
  if(spinning) return;
  if(balance < selectedMob.price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON'); return; }

  // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
  balance -= selectedMob.price; updateBalance();

  // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
  const lose = selectedMob.lose;
  const win = selectedMob.win;
  const epic = Math.max(0, 1 - lose - win);
  const segs = [
    {id:0, label:'lose', value: lose},
    {id:1, label:'win', value: win},
    {id:2, label:'epic', value: epic}
  ];
  // –≤—ã–±–∏—Ä–∞–µ–º –∏—Å—Ö–æ–¥ –ø–æ —à–∞–Ω—Å–∞–º
  const r = Math.random();
  let prefix = 0; let chosenSeg = null;
  for(const s of segs){
    if(r < prefix + s.value){ chosenSeg = s; break; }
    prefix += s.value;
  }
  if(!chosenSeg) chosenSeg = segs[segs.length-1];

  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —É–≥–æ–ª, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∫–æ–ª–µ—Å–æ (—Ü–µ–Ω—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞)
  // –≤—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —É–≥–ª—ã –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–±–µ–∑ –≤—Ä–∞—â–µ–Ω–∏—è), –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è -pi/2
  const startAngles = [];
  let acc = -Math.PI/2;
  segs.forEach(s => { startAngles.push(acc); acc += s.value * 2 * Math.PI; });

  const segIndex = segs.findIndex(s => s.id === chosenSeg.id);
  // —Ü–µ–Ω—Ç—Ä —Å–µ–≥–º–µ–Ω—Ç–∞:
  const segCenterAngle = startAngles[segIndex] + (segs[segIndex].value * Math.PI);

  // –∞–Ω–∏–º–∞—Ü–∏—è: —Å–¥–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–æ—Ä–æ—Ç–æ–≤ + –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä —Å–µ–≥–º–µ–Ω—Ç–∞ –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–¥ —Å—Ç—Ä–µ–ª–∫–æ–π (–Ω–∞–≤–µ—Ä—Ö—É)
  const totalSpins = 4; // —Ü–µ–ª—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤
  const finalRotation = (totalSpins * 2 * Math.PI) - segCenterAngle; // –≤—Ä–∞—â–µ–Ω–∏–µ, –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫ –∫–∞–Ω–≤–∞—Å—É, –ø–æ–∫–∞–∂–µ—Ç –Ω—É–∂–Ω—ã–π —Å–µ–∫—Ç–æ—Ä –Ω–∞–≤–µ—Ä—Ö—É

  // –∞–Ω–∏–º–∏—Ä—É–µ–º –ø–ª–∞–≤–Ω–æ —Å easing
  let current = 0;
  spinning = true;
  const duration = 3500;
  const startTime = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

  function frame(now){
    const t = Math.min(1, (now - startTime) / duration);
    const eased = easeOutCubic(t);
    const angle = finalRotation * eased;
    // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º angle
    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.translate(C.cx, C.cy);
    ctx.rotate(angle);
    ctx.translate(-C.cx, -C.cy);
    drawRoulette(0); // drawRoulette –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â—É—é selectedMob –¥–ª—è —Ü–≤–µ—Ç–∞/—Å–µ–≥–º–µ–Ω—Ç–æ–≤
    ctx.restore();

    if(t < 1){
      requestAnimationFrame(frame);
    } else {
      // –∑–∞–∫–æ–Ω—á–∏–ª–∏ ‚Äî –æ–±—ä—è–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      spinning = false;
      finishSpin(chosenSeg.id);
    }
  }
  requestAnimationFrame(frame);
}

/* –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–ø–∏–Ω–∞: –≤—ã–¥–∞—á–∞ –ø—Ä–∏–∑–∞ / –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥. */
function finishSpin(segId){
  if(segId === 0){
    // –ø—Ä–æ–∏–≥—Ä—ã—à
    alert('‚ùå –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!');
  } else if(segId === 1){
    // –ø–æ–±–µ–¥–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞–≤–∫—É
    balance += selectedMob.price; updateBalance();
    alert(`‚úÖ –ü–æ–±–µ–¥–∞ ‚Äî –≤–∞—à–∞ —Å—Ç–∞–≤–∫–∞ ${selectedMob.price} TON –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞`);
  } else {
    // —ç–ø–∏–∫ ‚Äî –≤—ã–¥–∞—ë–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫
    const gift = gifts.find(g => g.name === selectedMob.epicGift) || { name: selectedMob.epicGift, price: 0 };
    inventory.push(gift);
    renderInventory();
    // –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞
    // —Å–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ roulettes –¥–ª—è fly
    const fakeEl = document.createElement('div');
    fakeEl.style.position='fixed';
    const rectCanvas = canvas.getBoundingClientRect();
    fakeEl.style.left = (rectCanvas.left + rectCanvas.width/2 - 40) + 'px';
    fakeEl.style.top = (rectCanvas.top + rectCanvas.height/2 - 40) + 'px';
    fakeEl.style.width='80px'; fakeEl.style.height='80px';
    document.body.appendChild(fakeEl);
    flyGift(gift, fakeEl);
    setTimeout(()=>{ try{ fakeEl.remove(); }catch(e){} },1200);
    alert(`üåü –≠–ø–∏—á–µ—Å–∫–∞—è –ø–æ–±–µ–¥–∞! –í—ã –ø–æ–ª—É—á–∏–ª–∏: ${gift.name}`);
  }
}

/* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
document.getElementById('spinButton').onclick = spinRoulette;

/* === –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º === */
function preloadImages(list){
  return Promise.all(list.map((src,idx) => new Promise(resolve=>{
    const img = new Image();
    img.onload = img.onerror = ()=>{ resolve(src); };
    img.src = src;
  })));
}

function preloadAssets(){
  const toPreload = [];
  // —Ñ–æ–Ω—ã
  Object.values(backgrounds).forEach(p=>toPreload.push(p));
  // ores
  oreTypes.forEach(o=>toPreload.push(o.img));
  // mobs images
  mobsData.forEach(m=> toPreload.push(m.img) );
  // icons
  toPreload.push('ton.svg');
  // emoji animations (optional: try to preload jsons in emoji/ but ignore errors)
  // build progress bar
  const progBar = document.getElementById('progressBar');
  let loaded = 0;
  const total = toPreload.length;
  // load each with onload
  toPreload.forEach(src=>{
    const img = new Image();
    img.onload = img.onerror = ()=>{
      loaded++; progBar.style.width = Math.round(loaded/total*100) + '%';
      if(loaded === total){
        // small delay to allow UX
        setTimeout(()=>{ onAssetsLoaded(); }, 300);
      }
    };
    img.src = src;
  });
  // also try to preload emoji JSONs (not blocking)
  // but we don't fail on errors; we'll attempt to load animations later when necessary
}

function onAssetsLoaded(){
  // hide loader
  document.getElementById('loader').classList.add('hidden');
  // set initial background
  if(backgrounds.menu) document.body.style.backgroundImage = `url(${backgrounds.menu})`;
  updateBalance();
  // generate grids
  generateMineGrid();
  generateMines();
  // populate gift select (for gift staking)
  const giftSelect = document.getElementById('giftStake');
  gifts.forEach(g=>{
    const o = document.createElement('option'); o.value=g.name; o.textContent = `${g.name} (${g.price} TON)`; giftSelect.appendChild(o);
  });
  // render mobs list
  renderMobs();
}

/* === –°—Ç–∞–≤–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å === */
function updateStakeInput(){
  const type = document.querySelector('input[name="stakeType"]:checked').value;
  document.getElementById('tonStake').style.display = type === 'ton' ? 'inline-block' : 'none';
  document.getElementById('giftStake').style.display = type === 'gift' ? 'inline-block' : 'none';
}

/* === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ === */
preloadAssets();

/* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI —Å–æ—Å—Ç–æ—è–Ω–∏—è --- */
updateBalance();

/* === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ–ª–æ—á–∏: —â–∞–¥—è—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Lottie (–∞–Ω–∏–º–∞—Ü–∏—è –ª–æ–∞–¥–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞) === */
/* –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ emoji –±—É–¥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, —ç—Ç–æ –Ω–µ —Å–ª–æ–º–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –º—ã –∏—Ö –≥—Ä—É–∑–∏–º –ø–æ –º–µ—Å—Ç—É. */

/* === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∞—Ä–∫–∞ –ø–æ —Ü–µ–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —à–∞—Ö—Ç–µ) - —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞: getGiftByPrice === */

</script>
</body>
</html>
