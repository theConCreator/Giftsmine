<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiftsMine — fixed</title>
<style>
  @font-face{font-family:'Minecraft';src:url('minecraft.ttf') format('truetype');}
  :root{--panel:rgba(0,0,0,0.45);--accent:#ff9a9e;}
  html,body{height:100%;margin:0;font-family:'Minecraft',sans-serif;background:#000;color:#fff;}
  body{display:flex;flex-direction:column;overflow:hidden;background-size:cover;background-position:center}
  /* loader */
  #loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:9999}
  #loader.hidden{opacity:0;pointer-events:none;transition:opacity .4s}
  #loaderAnimation{width:150px;height:150px;margin-bottom:12px}
  #loaderProgress{width:48%;height:12px;background:#222;border-radius:999px;overflow:hidden}
  #loaderProgressBar{width:0;height:100%;background:var(--accent);transition:width .25s}
  /* header */
  #balance{padding:12px 16px;text-align:right;background:var(--panel);backdrop-filter:blur(6px);font-weight:800}
  main{flex:1;overflow:auto;padding:14px;padding-bottom:110px;background:linear-gradient(180deg,rgba(0,0,0,0.06),rgba(0,0,0,0.12))}
  main:not(.active){display:none}
  h2{margin:0 0 8px 0;text-align:center}
  .banner{width:100%;aspect-ratio:5/1;border-radius:12px;overflow:hidden;margin-bottom:12px}
  .banner img{width:100%;height:100%;object-fit:cover}
  /* tab bar */
  .tab-bar{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:10px;padding:10px;background:rgba(0,0,0,0.16);border-radius:12px;z-index:999}
  .tab-bar button{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.6);color:#fff;font-weight:800;cursor:pointer}
  .tab-bar button.active{background:linear-gradient(135deg,#a1c4fd,#c2e9fb)}
  /* mine grid */
  .grid{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .block{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1/1;background:#2b2b2b;cursor:pointer;box-shadow:inset 0 -12px 26px rgba(0,0,0,0.45);image-rendering:pixelated}
  .block .ore{position:absolute;inset:0;background-size:cover;background-position:center}
  .destroy-overlay{position:absolute;inset:0;image-rendering:pixelated;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 80ms linear;z-index:5}
  .price-box{position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,0.6);padding:4px 6px;border-radius:8px;font-weight:800;display:flex;align-items:center;gap:6px;z-index:6;font-size:0.85rem}
  .timer-box{position:absolute;left:8px;top:8px;background:rgba(0,0,0,0.6);padding:4px 6px;border-radius:8px;font-weight:800;display:flex;align-items:center;gap:6px;z-index:6;font-size:0.85rem;display:none}
  .block.cooldown{filter:brightness(0.7);pointer-events:none}
  .gift-preview-block{position:absolute;inset:12%;z-index:6;display:flex;align-items:center;justify-content:center;pointer-events:none}
  /* inventory */
  .inventory-list{display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}
  .gift-item{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:8px}
  .gift-top{display:flex;gap:12px;align-items:center}
  .gift-preview{width:72px;height:72px;border-radius:8px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .gift-name{font-weight:800}
  .gift-actions{display:flex;gap:8px}
  .btn{padding:8px;border-radius:8px;border:none;cursor:pointer;font-weight:800;background:rgba(0,0,0,0.6);color:#fff}
  .btn.primary{background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#111}
  .btn.secondary{background:linear-gradient(135deg,#6a11cb,#2575fc);color:#fff}
  /* balance layout */
  .balance-section{max-width:700px;margin:0 auto;background:var(--panel);padding:12px;border-radius:10px}
  .balance-btn{width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.6);color:#fff;margin-bottom:8px;font-weight:800;cursor:pointer}
  .transactions{max-height:260px;overflow:auto;padding-top:8px}
  /* fly layer */
  #flyLayer{position:fixed;inset:0;pointer-events:none;z-index:1500}
  .flying{position:absolute;width:64px;height:64px;transform-origin:center center}
  @media (max-width:720px){.grid{grid-template-columns:repeat(4,1fr);gap:8px}.inventory-list{padding:0 8px}}
</style>
</head>
<body>
  <div id="loader">
    <div id="loaderAnimation"></div>
    <div id="loaderProgress"><div id="loaderProgressBar"></div></div>
    <div style="margin-top:10px;color:#ddd">Загрузка ресурсов...</div>
  </div>

  <div id="balance">Баланс: 10000 <img src="ton.svg" width="18" style="vertical-align:middle"></div>

  <main id="menu" class="active">
    <h2>Главное меню</h2>
    <div class="banner"><img src="images/banner.jpg" alt="banner"></div>
    <p style="text-align:center;color:#bbb">Выбирай режим и зарабатывай подарки!</p>
  </main>

  <main id="mine">
    <h2>Шахта</h2>
    <div id="brokenBlocks" style="text-align:center;margin-bottom:12px">Сломано блоков: 0</div>
    <div class="grid" id="mineGrid"></div>
  </main>

  <main id="inventory">
    <h2>Инвентарь</h2>
    <div class="inventory-list" id="inventoryList"></div>
  </main>

  <main id="balanceTab">
    <h2>Баланс</h2>
    <div class="balance-section">
      <div style="margin-bottom:8px;font-weight:800">Пополнение</div>
      <button class="balance-btn" onclick="promptAdd('ton')"><span>TON кошелёк</span><span>0%</span></button>
      <button class="balance-btn" onclick="promptAdd('cryptobot')"><span>CryptoBot</span><span>5%</span></button>
      <button class="balance-btn" onclick="promptAdd('stars')"><span>Telegram Stars</span><span>20%</span></button>
    </div>

    <div class="balance-section" style="margin-top:12px">
      <div style="margin-bottom:8px;font-weight:800">Промокод</div>
      <input id="promoCode" type="text" placeholder="Введите промокод">
      <button class="btn secondary" style="margin-top:8px;width:100%" onclick="redeemPromo()">Активировать</button>
    </div>

    <div class="balance-section" style="margin-top:12px">
      <div style="margin-bottom:8px;font-weight:800">Реферальная программа</div>
      <div id="refInfo" style="color:#ccc">Базовый бонус +1.0%. +0.5% за каждый сломанный блок (макс 20%).</div>
    </div>

    <div class="balance-section" style="margin-top:12px">
      <div style="margin-bottom:8px;font-weight:800">История операций</div>
      <div class="transactions" id="transactionHistory"></div>
    </div>
  </main>

  <div class="tab-bar">
    <button id="tab-menu" class="active" onclick="showTab('menu')">Меню</button>
    <button id="tab-mine" onclick="showTab('mine')">Шахта</button>
    <button id="tab-inventory" onclick="showTab('inventory')">Инвентарь</button>
    <button id="tab-balanceTab" onclick="showTab('balanceTab')">Баланс</button>
  </div>

  <div id="flyLayer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
  <script>
/* ====== State ====== */
let balance = 10000.00;
let transactions = []; // newest first via unshift
let inventory = [];
let brokenBlocks = 0;
let refPercent = 1.0;
const MAX_REF = 20.0;

const animationMap = {}; // giftName -> blobURL (from preload)
const inventoryAnims = []; // keep Lottie instances for inventory previews
const glassAnims = new WeakMap(); // cell -> lottie instance for glass preview

const backgrounds = {
  menu: 'images/menu.jpg',
  mine: 'images/mine.jpg',
  inventory: 'images/inventory.jpg',
  balanceTab: 'images/mobs.jpg'
};

/* Full gift list (kept complete) */
const gifts = [
  {name:"Hypno Lollipop",price:1.77},{name:"Desk Calendar",price:1.31},
  {name:"B-Day Candle",price:1.32},{name:"Lol Pop",price:1.32},
  {name:"Lunar Snake",price:1.38},{name:"Snake Box",price:1.36},
  {name:"Xmas Stocking",price:1.38},{name:"Whip Cupcake",price:1.38},
  {name:"Candy Cane",price:1.48},{name:"Pet Snake",price:1.58},
  {name:"Jester Hat",price:1.62},{name:"Snoop Dogg",price:1.64},
  {name:"Homemade Cake",price:1.7},{name:"Holiday Drink",price:1.7},
  {name:"Jingle Bells",price:1.74},{name:"Cookie Heart",price:1.75},
  {name:"Big Year",price:1.78},{name:"Party Sparkler",price:1.8},
  {name:"Winter Wreath",price:1.79},{name:"Swag Bag",price:1.91},
  {name:"Tama Gadget",price:1.93},{name:"Ginger Cookie",price:1.95},
  {name:"Moon Pendant",price:1.96},{name:"Jack-in-the-Box",price:2.01},
  {name:"Spiced Wine",price:2.12},{name:"Stellar Rocket",price:2.19},
  {name:"Star Notepad",price:2.32},{name:"Easter Egg",price:2.46},
  {name:"Restless Jar",price:2.5},{name:"Santa Hat",price:2.6},
  {name:"Snow Globe",price:2.65},{name:"Hex Pot",price:2.7},
  {name:"Joyful Bundle",price:2.71},{name:"Lush Bouquet",price:2.84},
  {name:"Witch Hat",price:2.86},{name:"Light Sword",price:3.13},
  {name:"Spy Agaric",price:3.2},{name:"Bow Tie",price:3.22},
  {name:"Eternal Candle",price:3.38},{name:"Bunny Muffin",price:3.34},
  {name:"Jelly Bunny",price:3.43},{name:"Berry Box",price:3.58},
  {name:"Evil Eye",price:3.6},{name:"Snow Mittens",price:3.67},
  {name:"Valentine Box",price:4.2},{name:"Snoop Cigar",price:4.26},
  {name:"Sakura Flower",price:4.77},{name:"Hanging Star",price:5.26},
  {name:"Jolly Chimp",price:5.34},{name:"Sleigh Bell",price:7.63},
  {name:"Skull Flower",price:7.7},{name:"Crystal Ball",price:7.86},
  {name:"Record Player",price:7.91},{name:"Love Candle",price:7.94},
  {name:"Top Hat",price:7.99},{name:"Trapped Heart",price:8.69},
  {name:"Love Potion",price:8.79},{name:"Flying Broom",price:9.45},
  {name:"Cupid Charm",price:11.26},{name:"Eternal Rose",price:13.71},
  {name:"Ionic Dryer",price:14.21},{name:"Diamond Ring",price:16.39},
  {name:"Voodoo Doll",price:16.43},{name:"Mad Pumpkin",price:17.91},
  {name:"Toy Bear",price:19.3},{name:"Vintage Cigar",price:23.98},
  {name:"Low Rider",price:24.8},{name:"Signet Ring",price:25.1},
  {name:"Neko Helmet",price:26.41},{name:"Electric Skull",price:31},
  {name:"Kissed Frog",price:34},{name:"Swiss Watch",price:35},
  {name:"Sharp Tongue",price:39.69},{name:"Scared Cat",price:43.6},
  {name:"Genie Lamp",price:47.07},{name:"Westside Sign",price:51.27},
  {name:"Bonded Ring",price:54.99},{name:"Gem Signet",price:72.98},
  {name:"Magic Potion",price:72.98},{name:"Ion Gem",price:83},
  {name:"Astral Shard",price:95.97},{name:"Perfume Bottle",price:95.99},
  {name:"Loot Bag",price:90.1},{name:"Mini Oscar",price:123.89},
  {name:"Nail Bracelet",price:129.84},{name:"Heroic Helmet",price:219.99},
  {name:"Precious Peach",price:379.99},{name:"Durov’s Cap",price:794.9},
  {name:"Heart Locket",price:1450},{name:"Plush Pepe",price:5199}
];

/* ore definitions */
const oreTypes = [
  {name:'coal', img:'images/ores/coal.png', hits:3, min:1, max:5},
  {name:'iron', img:'images/ores/iron.png', hits:4, min:3, max:10},
  {name:'gold', img:'images/ores/gold.png', hits:5, min:6, max:20},
  {name:'diamond', img:'images/ores/diamond.png', hits:6, min:10, max:50},
  {name:'emerald', img:'images/ores/emerald.png', hits:7, min:15, max:70},
  {name:'earth', img:'images/ores/earth.png', hits:2, min:0.1, max:1, type:'earth'},
  {name:'glass', img:'images/ores/glass.png', hits:4, min:3, max:20, type:'glass'}
];

/* ===== UI helpers ===== */
function setBalanceUI(){ document.getElementById('balance').innerHTML = `Баланс: ${balance.toFixed(2)} <img src="ton.svg" width="18" style="vertical-align:middle">`; }
function setTransactionsUI(){ const el=document.getElementById('transactionHistory'); el.innerHTML=''; transactions.forEach(t=>{ const d=document.createElement('div'); d.style.padding='6px 0'; d.style.fontSize='0.9rem'; d.style.color='#ddd'; d.textContent = t; el.appendChild(d); }); }
function setBrokenUI(){ document.getElementById('brokenBlocks').textContent = `Сломано блоков: ${brokenBlocks}`; document.getElementById('refInfo').textContent = `Бонус: ${refPercent.toFixed(1)}% (+0.5% за блок, макс ${MAX_REF}%)`; }
function showTab(id){ document.querySelectorAll('main').forEach(m=>m.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); if(backgrounds[id]) document.body.style.backgroundImage=`url(${backgrounds[id]})`; if(id==='inventory') renderInventory(); }

/* ===== Preload (safe) ===== */
async function preloadAll(){
  const imageFiles = [
    ...Object.values(backgrounds),
    'ton.svg','icons/cryptobot.svg','stars.svg',
    ...oreTypes.map(o=>o.img),
    ...Array.from({length:10},(_,i)=>`destroy/destroy_stage_${i}.png`),
    'images/banner.jpg'
  ];
  const lottieFiles = gifts.map(g=>({name:g.name, path:`emoji/${g.name}.json`}));
  const total = imageFiles.length + lottieFiles.length;
  let done = 0;
  function tick(){ done++; const p = Math.round(done/total*100); document.getElementById('loaderProgressBar').style.width = p + '%'; }

  // images
  const imgPromises = imageFiles.map(src => new Promise(res => {
    const img = new Image();
    img.onload = img.onerror = ()=>{ tick(); res(); };
    img.src = src;
  }));

  // lottie JSONs -> store blob URLs in animationMap (skip missing)
  const lottiePromises = lottieFiles.map(item =>
    fetch(item.path).then(r => {
      if(!r.ok) throw new Error('no');
      return r.blob();
    }).then(blob => {
      const url = URL.createObjectURL(blob);
      animationMap[item.name] = url;
      tick();
    }).catch(()=>{
      // missing -> skip
      console.warn('skip lottie', item.path);
      tick();
    })
  );

  await Promise.all([...imgPromises, ...lottiePromises]).catch(()=>{});
  // small delay for UX
  await new Promise(r=>setTimeout(r,250));
}

/* ===== Gift selection logic (EV tuned) ===== */
function weightedChoice(pool, weightFn){
  const weights = pool.map(weightFn);
  const s = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*s;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}
function getGiftByPrice(price, maxMultiplier=3){
  // pool up to price * maxMultiplier, but weigh so EV ~90% (favor somewhat around price)
  const pool = gifts.filter(g => g.price <= price*maxMultiplier);
  if(pool.length === 0) return gifts[Math.floor(Math.random()*gifts.length)];
  return weightedChoice(pool, g => 1/(0.1 + Math.abs(Math.log(g.price/price)) + 0.1)); // prefer near price
}
function getGiftForGlass(price){
  // ensure gift >= 1.5x price
  const pool = gifts.filter(g => g.price >= price*1.5 && g.price <= price*3);
  if(pool.length) return pool[Math.floor(Math.random()*pool.length)];
  // fallback
  return getGiftByPrice(price,3);
}

/* ===== Mine logic (stable) ===== */
function createBlockElement(){
  const cell = document.createElement('div');
  cell.className = 'block';

  const oreDiv = document.createElement('div');
  oreDiv.className = 'ore';
  cell.appendChild(oreDiv);

  const destroyImg = document.createElement('img');
  destroyImg.className = 'destroy-overlay';
  cell.appendChild(destroyImg);

  const giftPreview = document.createElement('div');
  giftPreview.className = 'gift-preview-block';
  cell.appendChild(giftPreview);

  const priceBox = document.createElement('div');
  priceBox.className = 'price-box';
  cell.appendChild(priceBox);

  const timerBox = document.createElement('div');
  timerBox.className = 'timer-box';
  cell.appendChild(timerBox);

  return {cell, oreDiv, destroyImg, giftPreview, priceBox, timerBox};
}

function spawnBlock(cellObj){
  // cellObj may be element or {cell,...}
  let cell, oreDiv, destroyImg, giftPreview, priceBox, timerBox;
  if(cellObj.cell){
    ({cell, oreDiv, destroyImg, giftPreview, priceBox, timerBox} = cellObj);
  } else {
    ({cell, oreDiv, destroyImg, giftPreview, priceBox, timerBox} = createBlockElement());
    document.getElementById('mineGrid').appendChild(cell);
  }

  // pick ore
  const ore = oreTypes[Math.floor(Math.random()*oreTypes.length)];
  const price = (ore.type === 'earth') ? +(ore.min + Math.random()*(ore.max - ore.min)).toFixed(2) : +(ore.min + Math.random()*(ore.max - ore.min)).toFixed(2);

  // set visuals
  oreDiv.style.backgroundImage = `url(${ore.img})`;
  destroyImg.src = ''; destroyImg.style.opacity = '0';
  giftPreview.innerHTML = ''; giftPreview.style.display = 'none';
  priceBox.innerHTML = `${price.toFixed(2)} <img src="ton.svg" style="width:14px">`;
  timerBox.style.display = 'none';
  cell.classList.remove('cooldown');

  // if glass, prepare static preview
  if(ore.type === 'glass'){
    const displayed = getGiftForGlass(price);
    // if we preloaded lottie blob
    const path = animationMap[displayed.name] || `emoji/${displayed.name}.json`;
    // try to load lottie and stop at first frame
    try {
      const anim = lottie.loadAnimation({ container: giftPreview, renderer: 'svg', loop: false, autoplay: false, path });
      anim.addEventListener('DOMLoaded', ()=> {
        try{ anim.goToAndStop(0,true); }catch(e){}
        // keep anim instance to prevent it being destroyed (so preview remains)
        glassAnims.set(cell, anim);
        giftPreview.style.display = 'flex';
      });
    } catch(e){
      giftPreview.textContent = displayed.name;
      giftPreview.style.display = 'flex';
    }
    // store displayed gift for break logic
    cell.dataset.glassGift = JSON.stringify(displayed);
  } else {
    delete cell.dataset.glassGift;
  }

  // damage frames mapping: distribute frames 0..9 over hits
  const totalHits = ore.hits;
  const frames = [];
  for(let i=0;i<totalHits;i++){
    const idx = Math.round(i * (9 / Math.max(1, totalHits - 1)));
    frames.push(idx);
  }

  let hits = 0;
  // attach click
  const onClick = () => {
    if(cell.classList.contains('cooldown')) return;
    // if not enough balance, prevent full break; we charge at final break
    hits++;
    const frameIndex = frames[Math.min(hits-1, frames.length-1)];
    const destroyPath = `destroy/destroy_stage_${frameIndex}.png`;
    // assign src and show
    destroyImg.src = destroyPath;
    destroyImg.style.opacity = '1';

    if(hits < totalHits) return;

    // final: require full balance
    if(balance < price){ alert('Недостаточно TON для завершения ломания'); return; }

    // charge once
    balance -= price; setBalanceUI();
    transactions.unshift(`Списание: -${price.toFixed(2)} TON`);
    setTransactionsUI();

    // reward based on ore.type
    if(ore.type === 'earth'){
      // 70% small TON 0.1 else cheap gift (<2)
      if(Math.random() < 0.7){
        flyTon(cell, 0.10, ()=>{ balance += 0.10; setBalanceUI(); transactions.unshift('Получение из блока: +0.10 TON'); setTransactionsUI(); });
      } else {
        const pool = gifts.filter(g => g.price < 2);
        const chosen = pool.length ? pool[Math.floor(Math.random()*pool.length)] : getGiftByPrice(1);
        inventory.push(chosen); renderInventory(); flyGift(chosen, cell);
      }
    } else if(ore.type === 'glass'){
      // try displayed gift first
      let displayed = null;
      try { displayed = JSON.parse(cell.dataset.glassGift); } catch(e){}
      if(displayed && Math.random() < 0.75){
        inventory.push(displayed); renderInventory(); flyGift(displayed, cell);
      } else {
        const other = getGiftForGlass(price);
        inventory.push(other); renderInventory(); flyGift(other, cell);
      }
    } else {
      // normal ore: chance up to x3 but EV tuned
      const chosen = getGiftByPrice(price, 3);
      inventory.push(chosen); renderInventory(); flyGift(chosen, cell);
    }

    // update stats
    brokenBlocks++; refPercent = Math.min(MAX_REF, refPercent + 0.5); setBrokenUI();

    // cooldown / respawn UI
    const respawnMs = (60 + Math.random()*1740) * 1000;
    const mins = Math.round(respawnMs/60000);
    cell.classList.add('cooldown');
    timerBox.textContent = `${mins}m`;
    timerBox.style.display = 'flex';
    priceBox.style.display = 'flex';

    // cleanup glass anim instance if any
    const ga = glassAnims.get(cell);
    if(ga){ try{ ga.destroy(); }catch(e){} glassAnims.delete(cell); }

    // detach click
    cell.removeEventListener('click', onClick);

    setTimeout(()=>{
      // rebuild block
      spawnBlock({cell, oreDiv, destroyImg, giftPreview, priceBox, timerBox});
    }, respawnMs);
  };

  // attach click handler
  cell.removeEventListener('click', cell._onClickHandler || (()=>{}));
  cell._onClickHandler = onClick;
  cell.addEventListener('click', onClick);
}

/* create grid */
function generateMineGrid(){
  const grid = document.getElementById('mineGrid');
  grid.innerHTML = '';
  for(let i=0;i<16;i++){
    const el = createBlockElement();
    spawnBlock(el);
  }
}

/* ===== Fly animations ===== */
function flyGift(gift, fromCell){
  const rect = fromCell.getBoundingClientRect();
  const fly = document.createElement('div'); fly.className='flying';
  fly.style.left = rect.left + rect.width/2 - 32 + 'px';
  fly.style.top  = rect.top  + rect.height/2 - 32 + 'px';
  document.getElementById('flyLayer').appendChild(fly);

  const container = document.createElement('div'); container.style.width='64px'; container.style.height='64px';
  fly.appendChild(container);

  const path = animationMap[gift.name] || `emoji/${gift.name}.json`;
  let anim = null;
  try { anim = lottie.loadAnimation({ container, renderer:'svg', loop:true, autoplay:true, path }); }
  catch(e){ container.textContent = gift.name; container.style.fontSize='10px'; container.style.display='flex'; container.style.alignItems='center'; container.style.justifyContent='center'; }

  const invBtn = document.getElementById('tab-inventory').getBoundingClientRect();
  const targetX = invBtn.left + invBtn.width/2 - 32;
  const targetY = invBtn.top + invBtn.height/2 - 32;
  const dx = targetX - (rect.left + rect.width/2 - 32);
  const dy = targetY - (rect.top + rect.height/2 - 32);

  const wa = fly.animate([{ transform: 'translate(0,0)', opacity: 1 },{ transform: `translate(${dx}px, ${dy}px)`, opacity: 0.98 }], { duration: 1800, easing: 'cubic-bezier(.2,.8,.2,1)' });

  wa.onfinish = ()=>{ try{ if(anim) { anim.stop(); anim.destroy(); } }catch(e){} fly.remove(); };
  setTimeout(()=>{ if(document.body.contains(fly)){ try{ if(anim){ anim.stop(); anim.destroy(); } }catch(e){} fly.remove(); } }, 2400);
}

function flyTon(fromCell, amount, callback){
  const rect = fromCell.getBoundingClientRect();
  const fly = document.createElement('div'); fly.className='flying';
  fly.style.left = rect.left + rect.width/2 - 32 + 'px';
  fly.style.top  = rect.top  + rect.height/2 - 16 + 'px';
  fly.style.width = 'auto';
  fly.style.height = 'auto';
  fly.innerHTML = `<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.6);font-weight:800"><img src="ton.svg" style="width:22px">+${amount.toFixed(2)}</div>`;
  document.getElementById('flyLayer').appendChild(fly);

  const bal = document.getElementById('balance').getBoundingClientRect();
  const dx = (bal.left + 20) - (rect.left + rect.width/2 - 32);
  const dy = (bal.top) - (rect.top + rect.height/2 - 16);

  const wa = fly.animate([{ transform:'translate(0,0)', opacity:1 },{ transform:`translate(${dx}px, ${dy}px)`, opacity:0.98 }], { duration: 1400, easing:'ease-in-out' });

  wa.onfinish = ()=>{ fly.remove(); if(typeof callback === 'function') callback(); };
  setTimeout(()=>{ if(document.body.contains(fly)) fly.remove(); }, 1700);
}

/* ===== Inventory rendering (stable) ===== */
function clearInventoryAnims(){
  inventoryAnims.forEach(a => { try{ a.destroy(); }catch(e){} });
  inventoryAnims.length = 0;
}
function renderInventory(){
  const list = document.getElementById('inventoryList');
  list.innerHTML = '';
  clearInventoryAnims();
  inventory.forEach((gift, idx) => {
    const item = document.createElement('div'); item.className = 'gift-item';
    const top = document.createElement('div'); top.className = 'gift-top';
    const prev = document.createElement('div'); prev.className = 'gift-preview'; prev.id = `inv-prev-${idx}`;
    const info = document.createElement('div');
    info.innerHTML = `<div class="gift-name">${gift.name}</div><div class="small" style="color:#bbb">Цена: ${gift.price.toFixed(2)} TON</div>`;
    top.appendChild(prev); top.appendChild(info);
    item.appendChild(top);

    const actions = document.createElement('div'); actions.className = 'gift-actions';
    const sell = document.createElement('button'); sell.className='btn primary'; sell.textContent='Продать';
    sell.onclick = ()=>{ balance += gift.price; setBalanceUI(); transactions.unshift(`Продажа: +${gift.price.toFixed(2)} TON`); setTransactionsUI(); inventory.splice(idx,1); renderInventory(); };
    const withdraw = document.createElement('button'); withdraw.className='btn'; withdraw.textContent='Вывести';
    withdraw.onclick = ()=>{ transactions.unshift(`Вывод: ${gift.name}`); setTransactionsUI(); inventory.splice(idx,1); renderInventory(); alert('Вывод оформлен (заглушка)'); };
    actions.appendChild(sell); actions.appendChild(withdraw);
    item.appendChild(actions);
    list.appendChild(item);

    // load Lottie preview paused on first frame (keep anim alive so it doesn't vanish)
    const path = animationMap[gift.name] || `emoji/${gift.name}.json`;
    try {
      const anim = lottie.loadAnimation({ container: document.getElementById(`inv-prev-${idx}`), renderer: 'svg', loop: true, autoplay: false, path });
      anim.addEventListener('DOMLoaded', ()=> {
        try{ anim.goToAndStop(0,true); }catch(e){}
        // keep it (paused) to preserve preview — but do not autoplay to save perf
      });
      inventoryAnims.push(anim);
    } catch(e){
      prev.textContent = gift.name;
    }
  });
}

/* ===== Balance & promo ===== */
function redeemPromo(){
  const code = document.getElementById('promoCode').value.trim();
  if(!code) return alert('Введите промокод');
  if(code === 'BONUS10'){ balance += 10; setBalanceUI(); transactions.unshift('Промокод: +10 TON'); setTransactionsUI(); alert('Промокод активирован'); }
  else { transactions.unshift(`Промокод: неверный (${code})`); setTransactionsUI(); alert('Неверный промокод'); }
}
function promptAdd(method){
  const raw = prompt(`Сумма пополнения (${method}), пример: 100`, '100');
  if(!raw) return;
  const val = parseFloat(raw.replace(',', '.'));
  if(!val || isNaN(val) || val<=0) return alert('Некорректная сумма');
  let fee = 0; if(method === 'cryptobot') fee = 0.05; if(method === 'stars') fee = 0.20;
  const net = val * (1 - fee);
  const bonus = net * (refPercent/100.0);
  const totalAdd = net + bonus;
  balance += totalAdd;
  setBalanceUI();
  transactions.unshift(`Пополнение ${val.toFixed(2)} TON через ${method} (комиссия ${Math.round(fee*100)}%), бонус ${bonus.toFixed(2)}`);
  setTransactionsUI();
}

/* ===== Preload + start ===== */
async function startApp(){
  // loader animation (keep even if missing)
  try { lottie.loadAnimation({ container: document.getElementById('loaderAnimation'), renderer:'svg', loop:true, autoplay:true, path:'animations/myLoader.json' }); } catch(e){}

  await preloadAll();

  // hide loader
  document.getElementById('loader').classList.add('hidden');

  // initial UI
  setBalanceUI(); setTransactionsUI(); setBrokenUI();
  generateMineGrid();
  // ensure menu background visible
  if(backgrounds.menu) document.body.style.backgroundImage = `url(${backgrounds.menu})`;
}
startApp();

/* expose */
window.showTab = showTab;
window.renderInventory = renderInventory;
window.promptAdd = promptAdd;
window.redeemPromo = redeemPromo;
</script>
</body>
</html>
