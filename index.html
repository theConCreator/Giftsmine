<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiftsMine üéÅ</title>
<style>
body{margin:0;font-family:Segoe UI,sans-serif;color:#fff;display:flex;flex-direction:column;height:100vh;user-select:none;overflow:hidden;background-size:cover;background-position:center;background-repeat:no-repeat;}
#balance{padding:15px;text-align:right;font-size:1.2em;font-weight:bold;background:rgba(0,0,0,0.3);position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
main{flex:1;overflow-y:auto;padding:10px;display:none;background: rgba(0,0,0,0.2);}
main.active{display:block;}
.tab-bar{display:flex;justify-content:space-around;background: rgba(0,0,0,0.2);padding:10px;}
.tab-bar button{flex:1;margin:0 5px;padding:10px;border:none;background:linear-gradient(135deg,#ff9a9e,#fad0c4);color:#fff;font-weight:bold;cursor:pointer;transition:0.3s;}
.tab-bar button.active{background:linear-gradient(135deg,#a1c4fd,#c2e9fb);}
.grid{display:grid;gap:5px;justify-content:center;}
.mines-grid{grid-template-columns: repeat(5, minmax(50px,1fr));}

.mine-cell,.block{aspect-ratio:1/1;background:#555;border-radius:0;display:flex;align-items:center;justify-content:center;font-size:0.9em;font-weight:bold;cursor:pointer;transition:0.2s;position:relative;overflow:hidden;background-size:cover;background-position:center;}
.mine-cell.disabled{pointer-events:none;opacity:0.6;}
.mine-cell.revealed.safe{background:#4caf50;}
.mine-cell.revealed.mine{background:#f44336;}
.block-price{position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,0.5);padding:2px 4px;font-size:0.7em;border-radius:2px;display:flex;align-items:center;gap:2px;}
.inventory-list{display:flex;flex-wrap:wrap;gap:10px;}
.gift-item{background:#222;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,0.3);font-size:0.9em;flex:1 1 45%;display:flex;align-items:center;gap:10px;transition:0.3s;position:relative;}
.gift-img{width:50px;height:50px;}
.stake-options{margin-bottom:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
#mineReward,#nextReward{border:2px dashed #aaa;padding:10px;margin-left:10px;border-radius:10px;min-width:150px;text-align:center;font-weight:bold;position:relative;}
button#collectReward{padding:10px;background:linear-gradient(135deg,#ff9a9e,#fad0c4);border:none;color:#fff;font-weight:bold;cursor:pointer;border-radius:8px;margin-left:10px;transition:0.3s;}
button#collectReward:hover{background:linear-gradient(135deg,#a1c4fd,#c2e9fb);}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;background-size:cover;background-position:center;background-image:url('images/loader-bg.jpg');}
#loaderAnimation{width:150px;height:150px;margin-bottom:20px;}
.flying{position:absolute;width:80px;height:80px;pointer-events:none;z-index:1000;transition:all 1s ease;}
.timer-label{position:absolute;top:2px;left:2px;font-size:0.7em;background:rgba(0,0,0,0.5);padding:2px 4px;border-radius:2px;}
</style>
</head>
<body>

<div id="loader">
  <div id="loaderAnimation"></div>
  <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>
</div>

<div id="balance">–ë–∞–ª–∞–Ω—Å: 10000 <img src="ton.svg" style="width:16px;vertical-align:middle"></div>

<main id="menu" class="active">
<h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
<p>–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø–æ–¥–∞—Ä–∫–∏!</p>
</main>

<main id="mines">
<h2>–ú–∏–Ω—ã üí£</h2>
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
<div class="stake-options">
<label><input type="radio" name="stakeType" value="ton" checked onchange="updateStakeInput()"> TON</label>
<label><input type="radio" name="stakeType" value="gift" onchange="updateStakeInput()"> –ü–æ–¥–∞—Ä–æ–∫</label>
<input type="number" id="tonStake" min="0.5" step="0.1" placeholder="–°—Ç–∞–≤–∫–∞ TON">
<select id="giftStake" style="display:none"></select>
<button id="startMinesBtn" onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
</div>
<div>
<div id="mineReward">–í—ã–∏–≥—Ä—ã—à: ‚Äì</div>
<div id="nextReward">–°–ª–µ–¥—É—é—â–∏–π: ‚Äì</div>
<button id="collectReward" onclick="collectReward()">–ó–∞–±—Ä–∞—Ç—å</button>
</div>
</div>
<div class="grid mines-grid" id="minesGrid"></div>
<p id="minesStatus"></p>
</main>

<main id="mine">
<h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
<div class="grid" id="mineGrid" style="grid-template-columns:repeat(4,minmax(60px,1fr))"></div>
</main>

<main id="inventory">
<h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å üéí</h2>
<div class="inventory-list" id="inventoryList"></div>
</main>

<div class="tab-bar">
<button onclick="showTab('menu')" id="tab-menu" class="active">–ú–µ–Ω—é</button>
<button onclick="showTab('mines')" id="tab-mines">–ú–∏–Ω—ã</button>
<button onclick="showTab('mine')" id="tab-mine">–®–∞—Ö—Ç–∞</button>
<button onclick="showTab('inventory')" id="tab-inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script>
// ---- –õ–æ–∞–¥–µ—Ä ----
const loaderAnim=lottie.loadAnimation({container:document.getElementById('loaderAnimation'),renderer:'svg',loop:true,autoplay:true,path:'animations/loading.json'});

// ---- –ë–∞–ª–∞–Ω—Å ----
let balance=10000;
function updateBalance(){document.getElementById('balance').innerHTML=`–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} <img src="ton.svg" style="width:16px;vertical-align:middle">`;}

// ---- –í–∫–ª–∞–¥–∫–∏ ----
const backgrounds={menu:'url(images/menu.jpg)',mines:'url(images/mines.jpg)',mine:'url(images/mine.jpg)',inventory:'url(images/inventory.jpg)'};
function showTab(id){
    document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.body.style.backgroundImage=backgrounds[id]||'none';
    if(id==='inventory') renderInventory();
}

// ---- –ü–æ–¥–∞—Ä–∫–∏ ----
const rawGifts=[
{name:"Hypno Lollipop",price:1.77},{name:"Desk Calendar",price:1.31},{name:"Lunar Snake",price:1.32},{name:"Plush Pepe",price:5199}
]; // –¥–æ–±–∞–≤—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ —Å—é–¥–∞
const gifts=rawGifts.map(g=>({name:g.name,price:g.price,img:`emoji/${g.name}.json`})); 
let inventory=[];

// ---- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ----
function renderInventory(){
    const list=document.getElementById('inventoryList'); list.innerHTML='';
    inventory.forEach((item,index)=>{
        const div=document.createElement('div'); div.className='gift-item';
        const img=document.createElement('img'); img.className='gift-img'; img.src='emoji/'+item.name+'.png'; // —Å—Ç–∞—Ç–∏—á–Ω–æ
        const info=document.createElement('div'); info.innerText=item.name+' ‚Äì '+item.price;
        const tonIcon=document.createElement('img'); tonIcon.src='ton.svg'; tonIcon.style.width='16px'; tonIcon.style.verticalAlign='middle';
        info.appendChild(tonIcon);
        const sellBtn=document.createElement('button'); sellBtn.innerText=`–ü—Ä–æ–¥–∞—Ç—å`; sellBtn.onclick=()=>{balance+=item.price;inventory.splice(index,1);renderInventory();updateBalance();};
        div.appendChild(img); div.appendChild(info); div.appendChild(sellBtn);
        list.appendChild(div);
    });
}

// ---- –®–∞—Ö—Ç–∞ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º ----
const oreTypes=[{name:'Coal',min:1,max:3,img:'images/ores/coal.png'},{name:'Iron',min:3,max:6,img:'images/ores/iron.png'},{name:'Gold',min:7,max:10,img:'images/ores/gold.png'},{name:'Diamond',min:11,max:15,img:'images/ores/diamond.png'},{name:'Emerald',min:15,max:20,img:'images/ores/emerald.png'}];

function getGiftByBlockPrice(blockPrice){
    const min=blockPrice*0.5, max=blockPrice*1.3;
    let possible=gifts.filter(g=>g.price>=min && g.price<=max);
    if(possible.length===0) possible=gifts.sort((a,b)=>Math.abs(a.price-blockPrice)-Math.abs(b.price-blockPrice));
    return possible[Math.floor(Math.random()*possible.length)];
}

function spawnBlock(cell,basePrice=2){
    const ore=oreTypes[Math.floor(Math.random()*oreTypes.length)];
    const price=+(basePrice*(0.5+Math.random()*0.8)).toFixed(2);
    cell.className='block'; cell.style.backgroundImage=`url(${ore.img})`;
    cell.innerHTML='';
    const priceLabel=document.createElement('div'); priceLabel.className='block-price';
    priceLabel.innerHTML=price+' <img src="ton.svg" style="width:12px;vertical-align:middle">';
    cell.appendChild(priceLabel);
    let stage=0; let ready=true; 
    cell.onclick=()=>{
        if(!ready) return;
        stage++;
        cell.style.filter=`brightness(${1-stage*0.15})`;
        if(stage>=5){
            const gift=getGiftByBlockPrice(price);
            inventory.push(gift); renderInventory();
            // –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞
            const flying=document.createElement('img'); flying.src='emoji/'+gift.name+'.png'; flying.className='flying';
            document.body.appendChild(flying);
            const rect=cell.getBoundingClientRect();
            flying.style.left=rect.left+'px'; flying.style.top=rect.top+'px';
            setTimeout(()=>{flying.style.left=window.innerWidth-100+'px'; flying.style.top=window.innerHeight-100+'px';},50);
            setTimeout(()=>flying.remove(),1000);
            
            cell.onclick=null; cell.innerHTML='';
            ready=false;
            // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ —á–µ—Ä–µ–∑ —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è 1-30–º–∏–Ω
            const delay=(Math.random()*29+1)*60000;
            const timerLabel=document.createElement('div'); timerLabel.className='timer-label';
            let remaining=Math.floor(delay/1000);
            cell.appendChild(timerLabel);
            const interval=setInterval(()=>{
                if(remaining<=0){clearInterval(interval);spawnBlock(cell,price*1.05);return;}
                const minutes=Math.floor(remaining/60); const seconds=remaining%60;
                timerLabel.innerText=`${minutes}:${seconds.toString().padStart(2,'0')}`;
                remaining--;
            },1000);
        }
    };
}

function generateMineGrid(){
    const grid=document.getElementById('mineGrid'); grid.innerHTML='';
    for(let i=0;i<16;i++){
        const cell=document.createElement('div'); spawnBlock(cell,2+Math.random()*5); grid.appendChild(cell);
    }
}

// ---- –ú–∏–Ω—ã (—Ñ–∏–∫—Å –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∞—Ä–∫–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞) ----
let minesGrid=[]; let minesActive=false; let minesLost=false; let mineMultiplier=1; let currentStakeValue=0; let nextReward=null;

function generateMines(){
    const grid=document.getElementById('minesGrid'); grid.innerHTML=''; minesGrid=[];
    let mineIndexes=[]; while(mineIndexes.length<5){let idx=Math.floor(Math.random()*25); if(!mineIndexes.includes(idx)) mineIndexes.push(idx);}
    for(let i=0;i<25;i++){
        const cell=document.createElement('div'); cell.className='mine-cell disabled';
        const isMine=mineIndexes.includes(i); cell.dataset.mine=isMine?'1':'0';
        cell.addEventListener('click',()=>{if(minesActive) revealMine(cell);});
        grid.appendChild(cell); minesGrid.push(cell);
    }
    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥–∞—Ä–æ–∫
    if(currentStakeValue) nextReward=getGiftByBlockPrice(currentStakeValue);
    document.getElementById('nextReward').innerText='–°–ª–µ–¥—É—é—â–∏–π: '+(nextReward?nextReward.name:'‚Äì');
}

function revealMine(cell){
    if(cell.dataset.mine==='1'){cell.classList.add('revealed','mine'); minesActive=false; minesLost=true; document.getElementById('mineReward').innerText='–í—ã–∏–≥—Ä—ã—à: –ü–†–û–ò–ì–†–´–®'; document.querySelectorAll('.mine-cell').forEach(c=>c.classList.remove('disabled'));}
    else{cell.classList.add('revealed','safe'); mineMultiplier+=0.1; const rewardValue=currentStakeValue*mineMultiplier; document.getElementById('mineReward').innerText=`–í—ã–∏–≥—Ä—ã—à: ${rewardValue.toFixed(2)} TON`; nextReward=getGiftByBlockPrice(rewardValue); document.getElementById('nextReward').innerText='–°–ª–µ–¥—É—é—â–∏–π: '+nextReward.name;}
}

function updateStakeInput(){
    const type=document.querySelector('input[name="stakeType"]:checked').value;
    document.getElementById('tonStake').style.display=type==='ton'?'inline-block':'none';
    document.getElementById('giftStake').style.display=type==='gift'?'inline-block':'none';
}

function startMines(){
    const type=document.querySelector('input[name="stakeType"]:checked').value;
    if(minesActive){alert('–ò–≥—Ä–∞ —É–∂–µ –∏–¥—ë—Ç'); return;}
    if(type==='ton'){
        const stake=parseFloat(document.getElementById('tonStake').value);
        if(isNaN(stake)||stake<0.5){alert('–ú–∏–Ω–∏–º—É–º 0.5 TON'); return;}
        if(stake>balance){alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return;}
        balance-=stake; updateBalance(); currentStakeValue=stake;
    } else {
        if(!inventory.length){alert('–ù–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤'); return;}
        const idx=document.getElementById('giftStake').value; 
        if(idx===null){alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫'); return;}
        const gift=inventory.splice(idx,1)[0]; renderInventory(); currentStakeValue=gift.price;
    }
    mineMultiplier=1; minesActive=true; minesLost=false;
    document.querySelectorAll('.mine-cell').forEach(c=>c.classList.remove('disabled'));
    document.getElementById('mineReward').innerText=`–í—ã–∏–≥—Ä—ã—à: ${currentStakeValue} √ó ${mineMultiplier}`;
    generateMines();
}

function collectReward(){
    if(minesLost){alert('–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ'); return;}
    if(!currentStakeValue||mineMultiplier<=1){alert('–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞'); return;}
    const rewardValue=currentStakeValue*mineMultiplier;
    const gift=getGiftByBlockPrice(rewardValue); inventory.push(gift); renderInventory();
    alert(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${gift.name} (~${gift.price} TON)`);
    minesActive=false; mineMultiplier=1; currentStakeValue=0;
    generateMines();
    document.getElementById('mineReward').innerText='–í—ã–∏–≥—Ä—ã—à: ‚Äì'; 
    document.getElementById('nextReward').innerText='–°–ª–µ–¥—É—é—â–∏–π: ‚Äì';
}

// ---- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ ----
async function preloadAssets(){
    const images=[
        'images/menu.jpg','images/mines.jpg','images/mine.jpg','images/inventory.jpg',
        'images/ores/coal.png','images/ores/iron.png','images/ores/gold.png','images/ores/diamond.png','images/ores/emerald.png'
    ];
    const promises=images.map(src=>new Promise(resolve=>{const img=new Image();img.src=src;img.onload=resolve;img.onerror=resolve;}));
    await Promise.all(promises);
    document.getElementById('loader').style.display='none';
    showTab('menu'); generateMineGrid(); generateMines(); updateBalance();
}
preloadAssets();
</script>
</body>
</html>
