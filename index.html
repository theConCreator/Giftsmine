<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GiftsMine üéÅ</title>
  <style>
    @font-face { font-family:'Minecraft'; src:url('minecraft.ttf') format('truetype'); }
    :root{
      --panel-bg: rgba(20,20,20,0.95);
      --accent1: linear-gradient(135deg,#ff9a9e,#fad0c4);
      --accent2: linear-gradient(135deg,#6a11cb,#2575fc);
      --font-size: 14px;
    }

    html,body{height:100%;margin:0;padding:0;font-family:'Minecraft',sans-serif;color:#fff;background:#000;background-size:cover;background-position:center;}
    body{display:flex;flex-direction:column;font-size:var(--font-size);overflow:hidden;transition:background .5s;}

    /* top balance */
    #balance{padding:10px 14px;text-align:right;font-weight:700;background:rgba(0,0,0,0.14);backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(0,0,0,0.25);}

    /* main panels */
    main{flex:1;overflow-y:auto;padding:12px;padding-bottom:92px;display:none;background:rgba(0,0,0,0.12)}
    main.active{display:block}
    h2{margin:8px 0 14px 0;text-align:center}

    /* banner */
    .banner{width:100%;aspect-ratio:5/1;background:rgba(255,255,255,0.06);border-radius:10px;margin-bottom:12px;overflow:hidden}
    .banner img{width:100%;height:100%;object-fit:cover;display:block}

    /* tab bar */
    .tab-bar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:10px;background:rgba(0,0,0,0.22);border-top:2px solid rgba(255,255,255,0.08);z-index:1000;box-sizing:border-box}
    .tab-bar button{flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:var(--accent1);color:#fff}
    .tab-bar button.active{background:linear-gradient(135deg,#a1c4fd,#c2e9fb)}

    /* mine grid */
    .grid{display:grid;gap:8px;justify-content:center}
    #mineGrid{grid-template-columns: repeat(4, minmax(60px,1fr));}
    .block{aspect-ratio:1/1; background:#2f2f2f; border-radius:6px; overflow:hidden; background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer}
    .block-price{position:absolute; right:6px; bottom:6px; background:rgba(0,0,0,0.6); padding:3px 6px; font-size:0.72rem; border-radius:4px; display:flex; align-items:center; gap:6px}
    .block.cooldown{filter:brightness(0.5); cursor:not-allowed}

    /* inventory */
    .inventory-list{display:flex;flex-direction:column;gap:12px}
    .gift-item{background:var(--panel-bg); padding:10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.45)}
    .gift-top{display:flex;gap:10px;align-items:center}
    .gift-preview{width:60px;height:60px;border-radius:6px;background:#111;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:0.78rem;overflow:hidden}
    .gift-info{display:flex;flex-direction:column;gap:4px}
    .gift-name{font-weight:700}
    .gift-price{color:#cfcfcf;font-size:0.92rem}
    .gift-actions{display:flex;gap:8px;margin-top:8px}
    .gift-actions button{flex:1;padding:8px;border-radius:8px;border:none;background:var(--accent1);color:#fff;font-weight:700;cursor:pointer}

    /* flying gift */
    .flying{position:fixed;width:60px;height:60px;pointer-events:none;z-index:3000;will-change:transform}

    /* loader */
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000;z-index:4000;transition:opacity .35s}
    #loader.hidden{opacity:0;pointer-events:none}
    #loaderAnimation{width:160px;height:160px;margin-bottom:12px} /* —É–≤–µ–ª–∏—á–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—é */
    #loaderProgress{width:35%;height:8px;background:#222;border-radius:8px;overflow:hidden;margin-top:8px} /* —É–º–µ–Ω—å—à–∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä */
    #loaderProgressBar{height:100%;width:0;background:#ff9a9e;transition:width .25s}

    /* balance tab */
    .balance-wrapper{max-width:920px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .balance-section{background:var(--panel-bg);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45)}
    .balance-section h3{margin:0 0 8px 0;font-size:1rem}

    .method-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .method-row:hover{background:rgba(255,255,255,0.05)}
    .method-left{display:flex;align-items:center;gap:10px}
    .method-left img{width:28px;height:28px;display:block}
    .method-label{font-weight:700}
    .method-right{display:flex;align-items:center;gap:12px}
    .method-percent-box{display:flex;flex-direction:column;align-items:center;min-width:48px}
    .method-percent{color:#bfc9d9;font-weight:700;font-size:0.95rem}
    .method-fee{font-size:0.72rem;color:#aaa}
    .method-action{padding:8px 12px;border-radius:8px;border:none;background:var(--accent2);color:#fff;cursor:pointer;font-weight:700}

    .promo-row{display:flex;gap:10px;align-items:center}
    .promo-input{flex:1;padding:10px 12px;border-radius:10px;border:none;outline:none;background:rgba(255,255,255,0.06);color:#fff;font-weight:700}
    .promo-btn{padding:10px 14px;border-radius:10px;border:none;background:#27ae60;color:#fff;font-weight:700;cursor:pointer}

    .history-box{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03)}
    .tx-item{font-size:0.88rem;color:#ddd;padding:6px 8px;border-radius:6px;background:rgba(0,0,0,0.12)}

    @media (max-width:680px){
      #loaderProgress{width:70%}
      .tab-bar{padding:8px}
    }
  </style>
</head>
<body>
  <!-- LOADER -->
  <div id="loader">
    <div id="loaderAnimation"></div>
    <div id="loaderProgress"><div id="loaderProgressBar"></div></div>
    <p style="color:#fff;margin-top:8px">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>
  </div>

  <!-- TOP BALANCE -->
  <div id="balance">–ë–∞–ª–∞–Ω—Å: 10000 <img src="ton.svg" style="width:16px;vertical-align:middle"></div>

  <!-- MAIN PAGES -->
  <main id="menu" class="active">
    <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <a href="https://t.me/theConCreator" target="_blank" class="banner">
      <img src="images/banner.jpg" alt="–†–µ–∫–ª–∞–º–∞ –±–∞–Ω–Ω–µ—Ä">
    </a>
    <p style="text-align:center;color:#bbb">–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø–æ–¥–∞—Ä–∫–∏!</p>
  </main>

  <main id="mine">
    <h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
    <div id="brokenBlocks" style="text-align:center;margin-bottom:12px">–°–ª–æ–º–∞–Ω–æ –±–ª–æ–∫–æ–≤: 0</div>
    <div class="grid" id="mineGrid"></div>
  </main>

  <main id="inventory">
    <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å üéí</h2>
    <div class="inventory-list" id="inventoryList"></div>
  </main>

  <main id="balanceTab">
    <h2>–ë–∞–ª–∞–Ω—Å üí∞</h2>
    <div class="balance-wrapper">
      <div class="balance-section">
        <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>

        <div class="method-row" onclick="addBalance('ton',0)">
          <div class="method-left">
            <img src="ton.svg" alt="TON">
            <span class="method-label">Ton –∫–æ—à–µ–ª—ë–∫</span>
          </div>
          <div class="method-right">
            <div class="method-percent-box">
              <span class="method-fee">–∫–æ–º–∏—Å—Å–∏—è</span>
              <span class="method-percent">0%</span>
            </div>
            <button class="method-action" onclick="addBalance('ton',0); event.stopPropagation();">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div class="method-row" onclick="addBalance('crypto',5)">
          <div class="method-left">
            <img src="icons/cryptobot.svg" alt="Crypto bot">
            <span class="method-label">Crypto bot</span>
          </div>
          <div class="method-right">
            <div class="method-percent-box">
              <span class="method-fee">–∫–æ–º–∏—Å—Å–∏—è</span>
              <span class="method-percent">5%</span>
            </div>
            <button class="method-action" onclick="addBalance('crypto',5); event.stopPropagation();">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div class="method-row" onclick="addBalance('stars',20)">
          <div class="method-left">
            <img src="icons/stars.svg" alt="Stars">
            <span class="method-label">Telegram Stars</span>
          </div>
          <div class="method-right">
            <div class="method-percent-box">
              <span class="method-fee">–∫–æ–º–∏—Å—Å–∏—è</span>
              <span class="method-percent">20%</span>
            </div>
            <button class="method-action" onclick="addBalance('stars',20); event.stopPropagation();">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
        </div>

      </div>

      <div class="balance-section">
        <h3>–ü—Ä–æ–º–æ–∫–æ–¥</h3>
        <div class="promo-row">
          <input id="promoInput" class="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" />
          <button class="promo-btn" onclick="redeemPromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <div class="balance-section">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div id="transactionHistory" class="history-box"></div>
      </div>
    </div>
  </main>

  <div class="tab-bar">
    <button onclick="showTab('menu')" id="tab-menu" class="active">–ú–µ–Ω—é</button>
    <button onclick="showTab('mine')" id="tab-mine">–®–∞—Ö—Ç–∞</button>
    <button onclick="showTab('inventory')" id="tab-inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
    <button onclick="showTab('balanceTab')" id="tab-balanceTab">–ë–∞–ª–∞–Ω—Å</button>
  </div>

  <!-- Lottie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>

  <script>
    // -------------------------
    // State & config
    // -------------------------
    let balance = 10000;
    let transactions = []; // newest first (unshift)
    let inventory = [];
    let brokenBlocks = 0;
    let firstMineCount = 0;

    const backgrounds = {
      menu: 'images/menu.jpg',
      mine: 'images/mine.jpg',
      inventory: 'images/inventory.jpg',
      balanceTab: 'images/mobs.jpg'
    };
    document.body.style.backgroundImage = `url(${backgrounds.menu})`;

    // full gifts list
    const gifts = [
      {name:"Hypno Lollipop",price:1.77}, {name:"Desk Calendar",price:1.31},
      {name:"B-Day Candle",price:1.32}, {name:"Lol Pop",price:1.32},
      {name:"Lunar Snake",price:1.38}, {name:"Snake Box",price:1.36},
      {name:"Xmas Stocking",price:1.38}, {name:"Whip Cupcake",price:1.38},
      {name:"Candy Cane",price:1.48}, {name:"Pet Snake",price:1.58},
      {name:"Jester Hat",price:1.62}, {name:"Snoop Dogg",price:1.64},
      {name:"Homemade Cake",price:1.7}, {name:"Holiday Drink",price:1.7},
      {name:"Jingle Bells",price:1.74}, {name:"Cookie Heart",price:1.75},
      {name:"Big Year",price:1.78}, {name:"Party Sparkler",price:1.8},
      {name:"Winter Wreath",price:1.79}, {name:"Swag Bag",price:1.91},
      {name:"Tama Gadget",price:1.93}, {name:"Ginger Cookie",price:1.95},
      {name:"Moon Pendant",price:1.96}, {name:"Jack-in-the-Box",price:2.01},
      {name:"Spiced Wine",price:2.12}, {name:"Stellar Rocket",price:2.19},
      {name:"Star Notepad",price:2.32}, {name:"Easter Egg",price:2.46},
      {name:"Restless Jar",price:2.5}, {name:"Santa Hat",price:2.6},
      {name:"Snow Globe",price:2.65}, {name:"Hex Pot",price:2.7},
      {name:"Joyful Bundle",price:2.71}, {name:"Lush Bouquet",price:2.84},
      {name:"Witch Hat",price:2.86}, {name:"Light Sword",price:3.13},
      {name:"Spy Agaric",price:3.2}, {name:"Bow Tie",price:3.22},
      {name:"Eternal Candle",price:3.38}, {name:"Bunny Muffin",price:3.34},
      {name:"Jelly Bunny",price:3.43}, {name:"Berry Box",price:3.58},
      {name:"Evil Eye",price:3.6}, {name:"Snow Mittens",price:3.67},
      {name:"Valentine Box",price:4.2}, {name:"Snoop Cigar",price:4.26},
      {name:"Sakura Flower",price:4.77}, {name:"Hanging Star",price:5.26},
      {name:"Jolly Chimp",price:5.34}, {name:"Sleigh Bell",price:7.63},
      {name:"Skull Flower",price:7.7}, {name:"Crystal Ball",price:7.86},
      {name:"Record Player",price:7.91}, {name:"Love Candle",price:7.94},
      {name:"Top Hat",price:7.99}, {name:"Trapped Heart",price:8.69},
      {name:"Love Potion",price:8.79}, {name:"Flying Broom",price:9.45},
      {name:"Cupid Charm",price:11.26}, {name:"Eternal Rose",price:13.71},
      {name:"Ionic Dryer",price:14.21}, {name:"Diamond Ring",price:16.39},
      {name:"Voodoo Doll",price:16.43}, {name:"Mad Pumpkin",price:17.91},
      {name:"Toy Bear",price:19.3}, {name:"Vintage Cigar",price:23.98},
      {name:"Low Rider",price:24.8}, {name:"Signet Ring",price:25.1},
      {name:"Neko Helmet",price:26.41}, {name:"Electric Skull",price:31},
      {name:"Kissed Frog",price:34}, {name:"Swiss Watch",price:35},
      {name:"Sharp Tongue",price:39.69}, {name:"Scared Cat",price:43.6},
      {name:"Genie Lamp",price:47.07}, {name:"Westside Sign",price:51.27},
      {name:"Bonded Ring",price:54.99}, {name:"Gem Signet",price:72.98},
      {name:"Magic Potion",price:72.98}, {name:"Ion Gem",price:83},
      {name:"Astral Shard",price:95.97}, {name:"Perfume Bottle",price:95.99},
      {name:"Loot Bag",price:90.1}, {name:"Mini Oscar",price:123.89},
      {name:"Nail Bracelet",price:129.84}, {name:"Heroic Helmet",price:219.99},
      {name:"Precious Peach",price:379.99}, {name:"Durov‚Äôs Cap",price:794.9},
      {name:"Heart Locket",price:1450}, {name:"Plush Pepe",price:5199}
    ];

    const oreTypes = [
      {img:"images/ores/coal.png",hits:3},
      {img:"images/ores/iron.png",hits:4},
      {img:"images/ores/gold.png",hits:5},
      {img:"images/ores/diamond.png",hits:6},
      {img:"images/ores/emerald.png",hits:7}
    ];

    // preloaded lottie objectURLs
    const animationMap = {}; // giftName -> objectURL
    // track preview animations so we can destroy them on re-render
    const previewAnimations = [];

    // -------------------------
    // UI update helpers
    // -------------------------
    function updateBalanceUI(){
      document.getElementById('balance').innerHTML = `–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} <img src="ton.svg" style="width:16px;vertical-align:middle">`;
    }

    function updateTransactionHistoryUI(){
      const el = document.getElementById('transactionHistory');
      el.innerHTML = '';
      transactions.forEach(tx => {
        const d = document.createElement('div');
        d.className = 'tx-item';
        d.textContent = tx;
        el.appendChild(d);
      });
    }

    function updateBrokenBlocksUI(){
      document.getElementById('brokenBlocks').textContent = `–°–ª–æ–º–∞–Ω–æ –±–ª–æ–∫–æ–≤: ${brokenBlocks}`;
    }

    // -------------------------
    // Tabs
    // -------------------------
    function showTab(id){
      document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
      document.getElementById('tab-' + id).classList.add('active');
      document.body.style.backgroundImage = `url(${backgrounds[id]})`;
      if (id === 'inventory') renderInventory();
    }
    window.showTab = showTab;

    // -------------------------
    // Gift selection
    // -------------------------
    function getGiftByPrice(price, isFirst=false){
      let min = price * 0.5;
      let max = price * 1.45;
      if (firstMineCount < 2 && isFirst) max = price * 2;
      let possible = gifts.filter(g => g.price >= min && g.price <= max);
      if (isFirst && possible.length === 0) possible = gifts.filter(g => g.price >= price);
      if (possible.length === 0) possible = gifts;
      return possible[Math.floor(Math.random() * possible.length)];
    }

    // -------------------------
    // Mine grid
    // -------------------------
    function spawnBlock(cell, index=0){
      const ore = oreTypes[Math.floor(Math.random() * oreTypes.length)];
      let price = +(1 + Math.random() * 10).toFixed(2);
      cell.className = "block";
      cell.style.backgroundImage = `url(${ore.img})`;
      cell.innerHTML = `<div class="block-price">${price}<img src="ton.svg" style="width:12px;vertical-align:middle"></div>`;
      let hits = 0;
      cell.onclick = () => {
        hits++;
        if (hits >= ore.hits){
          // expense
          brokenBlocks++; updateBrokenBlocksUI();
          if (balance >= price){
            balance -= price; updateBalanceUI();
            transactions.unshift(`–û–ø–ª–∞—Ç–∞ –ª–æ–º–∫–∏: -${price.toFixed(2)} TON`);
          } else {
            transactions.unshift(`–õ–æ–º –±–ª–æ–∫–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤): ${price.toFixed(2)} TON`);
          }
          updateTransactionHistoryUI();

          // gift
          const gift = getGiftByPrice(price, index===0);
          inventory.push(gift);
          renderInventory();
          flyGift(gift, cell);
          firstMineCount++;

          // cooldown + respawn
          const respawn = (60 + Math.random() * 1740) * 1000;
          cell.classList.add('cooldown');
          cell.innerHTML = `<div style="position:absolute;top:4px;left:4px;font-size:0.7rem;">${Math.round(respawn/60000)}m</div>`;
          cell.onclick = null;
          setTimeout(()=>{ cell.classList.remove('cooldown'); spawnBlock(cell, index); }, respawn);
        }
      };
    }

    function generateMineGrid(){
      const grid = document.getElementById('mineGrid');
      grid.innerHTML = '';
      for (let i=0;i<16;i++){
        const cell = document.createElement('div');
        spawnBlock(cell, i);
        grid.appendChild(cell);
      }
    }

    // -------------------------
    // Flying gift (optimized)
    // -------------------------
    function flyGift(gift, fromCell){
      const rect = fromCell.getBoundingClientRect();
      const invBtnRect = document.getElementById('tab-inventory').getBoundingClientRect();

      const fly = document.createElement('div');
      fly.className = 'flying';

      // compute start (center) and set initial transform
      const startX = rect.left + rect.width/2 - 30;
      const startY = rect.top + rect.height/2 - 30;
      fly.style.transform = `translate(${startX}px, ${startY}px)`;
      document.body.appendChild(fly);

      // try use preloaded animation (objectURL) to avoid fetching
      let animInstance = null;
      const animPath = animationMap[gift.name] || `emoji/${encodeURIComponent(gift.name)}.json`;
      try {
        // loop false for transient animation
        animInstance = lottie.loadAnimation({
          container: fly,
          renderer: 'svg',
          loop: false,
          autoplay: true,
          path: animPath
        });
      } catch(e){
        // fallback
        fly.textContent = gift.name;
        fly.style.display = 'flex';
        fly.style.alignItems = 'center';
        fly.style.justifyContent = 'center';
        fly.style.fontSize = '0.75rem';
      }

      const targetX = invBtnRect.left + invBtnRect.width/2 - 30;
      const targetY = invBtnRect.top + invBtnRect.height/2 - 30;
      const dx = targetX - startX;
      const dy = targetY - startY;

      // animate transform only (no left/top changes) to avoid layout thrash / teleport
      const player = fly.animate([
        { transform: `translate(${startX}px, ${startY}px)` },
        { transform: `translate(${startX + dx}px, ${startY + dy}px)` }
      ], {
        duration: 1500,
        easing: 'cubic-bezier(.22,.8,.18,1)',
        fill: 'forwards'
      });

      player.onfinish = () => {
        try { if (animInstance && typeof animInstance.destroy === 'function') animInstance.destroy(); } catch(e){}
        fly.remove();
      };
    }

    // -------------------------
    // Inventory rendering (destroy previous preview animations first)
    // -------------------------
    function destroyPreviewAnimations(){
      while(previewAnimations.length){
        const a = previewAnimations.pop();
        try{ if (a && typeof a.destroy === 'function') a.destroy(); } catch(e){}
      }
    }

    function renderInventory(){
      // destroy preview anims to avoid memory / instance pile-up
      destroyPreviewAnimations();

      const list = document.getElementById('inventoryList');
      list.innerHTML = '';
      inventory.forEach((gift, idx) => {
        const div = document.createElement('div');
        div.className = 'gift-item';

        const top = document.createElement('div');
        top.className = 'gift-top';

        const prev = document.createElement('div');
        prev.className = 'gift-preview';

        // try to use preloaded animation
        if (animationMap[gift.name]){
          try{
            const anim = lottie.loadAnimation({
              container: prev,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              path: animationMap[gift.name]
            });
            previewAnimations.push(anim);
          } catch(e){
            prev.textContent = gift.name;
          }
        } else {
          // fallback: try direct path, if fails show text
          try {
            const anim = lottie.loadAnimation({
              container: prev,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              path: `emoji/${encodeURIComponent(gift.name)}.json`
            });
            previewAnimations.push(anim);
          } catch(e){
            prev.textContent = gift.name;
          }
        }

        const info = document.createElement('div');
        info.className = 'gift-info';
        info.innerHTML = `<div class="gift-name">${gift.name}</div>
                          <div class="gift-price">–¶–µ–Ω–∞: ${gift.price.toFixed(2)} <img src="ton.svg" style="width:12px;vertical-align:middle"></div>`;

        top.appendChild(prev);
        top.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'gift-actions';

        const sellBtn = document.createElement('button');
        sellBtn.textContent = '–ü—Ä–æ–¥–∞—Ç—å';
        sellBtn.onclick = () => {
          balance += gift.price; updateBalanceUI();
          inventory.splice(idx, 1);
          renderInventory();
          transactions.unshift(`–ü—Ä–æ–¥–∞–∂–∞: ${gift.name} +${gift.price.toFixed(2)} TON`);
          updateTransactionHistoryUI();
        };

        const withdrawBtn = document.createElement('button');
        withdrawBtn.textContent = '–í—ã–≤–µ—Å—Ç–∏';
        withdrawBtn.onclick = () => {
          alert('–í—ã–≤–æ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
          inventory.splice(idx, 1);
          renderInventory();
          transactions.unshift(`–í—ã–≤–æ–¥: ${gift.name}`);
          updateTransactionHistoryUI();
        };

        actions.appendChild(sellBtn);
        actions.appendChild(withdrawBtn);

        div.appendChild(top);
        div.appendChild(actions);
        list.appendChild(div);
      });
    }

    // -------------------------
    // Promo and balance actions
    // -------------------------
    function redeemPromo(){
      const code = (document.getElementById('promoInput')||{}).value || '';
      if (!code) { alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'); return; }
      if (code === 'BONUS10'){
        balance += 10; updateBalanceUI();
        transactions.unshift('–ü—Ä–æ–º–æ–∫–æ–¥: +10 TON');
        updateTransactionHistoryUI();
        alert('–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
      } else {
        transactions.unshift(`–ü—Ä–æ–º–æ–∫–æ–¥: –Ω–µ–≤–µ—Ä–Ω—ã–π (${code})`);
        updateTransactionHistoryUI();
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
      }
    }
    window.redeemPromo = redeemPromo;

    function addBalance(method, feePerc){
      const amount = 100;
      const net = +(amount - amount * (feePerc/100));
      balance += net;
      updateBalanceUI();
      transactions.unshift(`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${method}: +${net.toFixed(2)} TON (–∫–æ–º–∏—Å—Å–∏—è ${feePerc}%)`);
      updateTransactionHistoryUI();
      alert(`–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ ${method}: +${net.toFixed(2)} TON`);
    }
    window.addBalance = addBalance;

    // -------------------------
    // Preload images + lottie jsons
    // -------------------------
    function preloadAssets(){
      // gather images
      const imagePaths = [
        backgrounds.menu, backgrounds.mine, backgrounds.inventory, backgrounds.balanceTab,
        'ton.svg', 'images/banner.jpg',
        'icons/cryptobot.svg', 'icons/stars.svg',
        ...oreTypes.map(o => o.img)
      ];

      // lottie jsons for gifts
      const lottieList = gifts.map(g => ({ name: g.name, path: `emoji/${encodeURIComponent(g.name)}.json` }));

      const total = imagePaths.length + lottieList.length;
      let loaded = 0;
      const setProgress = () => {
        const pct = Math.round((loaded / total) * 100);
        document.getElementById('loaderProgressBar').style.width = pct + '%';
      };

      const imgPromises = imagePaths.map(src => new Promise(res => {
        const img = new Image();
        img.onload = img.onerror = function(){ loaded++; setProgress(); res(); };
        img.src = src;
      }));

      const lottiePromises = lottieList.map(item =>
        fetch(item.path).then(r => {
          if (!r.ok) return null;
          return r.blob();
        }).then(blob => {
          if (blob){
            animationMap[item.name] = URL.createObjectURL(blob);
          }
          loaded++; setProgress();
        }).catch(()=>{ loaded++; setProgress(); })
      );

      return Promise.all([...imgPromises, ...lottiePromises]);
    }

    // -------------------------
    // Initialization
    // -------------------------
    window.addEventListener('load', () => {
      // try to start loader Lottie (non-critical)
      try {
        lottie.loadAnimation({ container: document.getElementById('loaderAnimation'), renderer:'svg', loop:true, autoplay:true, path:'animations/myLoader.json' });
      } catch(e){ /* ignore if missing */ }

      preloadAssets().then(() => {
        setTimeout(() => {
          document.getElementById('loader').classList.add('hidden');
          generateMineGrid();
          updateBalanceUI();
          updateTransactionHistoryUI();
          updateBrokenBlocksUI();
          // initial background
          document.body.style.backgroundImage = `url(${backgrounds.menu})`;
        }, 300);
      });
    });

    // cleanup on unload: revoke object URLs and destroy preview animations
    window.addEventListener('beforeunload', () => {
      destroyPreviewAnimations();
      for (const k in animationMap){
        try{ URL.revokeObjectURL(animationMap[k]); } catch(e){}
      }
    });
  </script>
</body>
</html>
