<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiftsMine üéÅ</title>
<style>
  :root{--ton-size:14px;}
  /* BODY & LAYOUT */
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    color:#fff;
    height:100vh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    background:#000; /* –≤—Å–µ–≥–¥–∞ —á—ë—Ä–Ω—ã–π ‚Äî —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ–ª—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    background-size:cover;
    background-position:center;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  #balance{
    padding:12px 16px;
    text-align:right;
    font-weight:700;
    background:rgba(0,0,0,0.12);
    backdrop-filter: blur(6px);
    z-index:3;
  }

  main{
    flex:1;
    padding:12px;
    overflow:auto;
    display:none; /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ */
  }
  main.active{display:block;}

  /* bottom tabbar */
  .tab-bar{
    display:flex;
    gap:8px;
    padding:10px;
    background:rgba(0,0,0,0.12);
    border-top:1px solid rgba(255,255,255,0.04);
  }
  .tab-bar button{
    flex:1;
    padding:8px 10px;
    border-radius:10px;
    border:0;
    background:linear-gradient(135deg,#ff9a9e,#fad0c4);
    color:#fff;
    font-weight:700;
    cursor:pointer;
    box-shadow: 0 6px 14px rgba(0,0,0,0.35);
  }
  .tab-bar button.active{
    background:linear-gradient(135deg,#7bb7ff,#bfe9ff);
    color:#06233a;
  }

  /* grid utils */
  .grid{display:grid;gap:8px;justify-content:center;}
  /* mines grid 5x5 */
  .mines-grid{grid-template-columns:repeat(5,minmax(48px,1fr));}
  /* mine cell & block */
  .mine-cell,.block{
    aspect-ratio:1/1;
    background:#222;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    user-select:none;
    border-radius:6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    background-size:cover;
    background-position:center;
  }
  .mine-cell.disabled,.block.disabled{pointer-events:none;opacity:0.55;}
  .mine-cell.revealed.safe{background:#2e7d32;}
  .mine-cell.revealed.mine{background:#b71c1c;color:#fff;}
  .block-price{
    position:absolute;
    right:6px;
    bottom:6px;
    background:rgba(0,0,0,0.6);
    padding:4px 6px;
    border-radius:6px;
    font-size:12px;
    display:flex;
    gap:6px;
    align-items:center;
  }

  .block.cooldown{
    filter:brightness(0.45);
    cursor:default;
  }
  .block .cooldown-timer{
    position:absolute;
    left:6px;
    top:6px;
    font-size:12px;
    color:#fff;
    background:rgba(0,0,0,0.35);
    padding:2px 6px;
    border-radius:6px;
  }

  /* inventory */
  .inventory-list{display:flex;flex-wrap:wrap;gap:10px;padding:6px 0;}
  .gift-item{
    width:220px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));
    padding:10px;
    border-radius:10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    display:flex;
    gap:10px;
    align-items:center;
    flex-direction:column;
  }
  .gift-preview{width:70px;height:70px;}
  .gift-info{font-weight:700;text-align:center;}
  .gift-actions{display:flex;gap:8px;margin-top:8px;width:100%;}
  .gift-actions button{flex:1;padding:8px;border-radius:8px;border:0;font-weight:700;cursor:pointer;}
  .gift-actions .sell{background:#43a047;color:#fff;}
  .gift-actions .withdraw{background:#ffb300;color:#fff;}

  /* loader */
  #loader{
    position:fixed;
    inset:0;
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:12px;
    background:#000; /* —á—ë—Ä–Ω—ã–π —Ñ–æ–Ω */
  }
  #loader .fallback-spinner{
    width:48px;height:48px;border-radius:50%;
    border:6px solid rgba(255,255,255,0.08);
    border-top-color:#4fc3f7;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* small responsive */
  @media (max-width:640px){
    .gift-item{width:46%;}
    .tab-bar button{padding:8px 6px;}
  }
</style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div id="loaderAnimation" style="width:150px;height:150px;"></div>
    <div style="color:#fff;font-weight:700">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</div>
    <div id="loaderFallback" style="display:none;color:#aaa;font-size:13px;margin-top:6px;">(fallback animation)</div>
  </div>

  <!-- BALANCE -->
  <div id="balance">–ë–∞–ª–∞–Ω—Å: <span id="balValue">10000.00</span> <img src="ton.svg" alt="TON" style="width:16px;vertical-align:middle"></div>

  <!-- MAIN PAGES -->
  <main id="menu" class="active">
    <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <p>–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º ‚Äî —à–∞—Ö—Ç–∞, –º–∏–Ω—ã –∏–ª–∏ —Å–º–æ—Ç—Ä–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å. –£–¥–∞—á–∏!</p>
  </main>

  <main id="mines">
    <h2>–ú–∏–Ω—ã üí£</h2>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
      <div class="stake-options">
        <label><input type="radio" name="stakeType" value="ton" checked onchange="updateStakeInput()"> TON</label>
        <label style="margin-left:8px;"><input type="radio" name="stakeType" value="gift" onchange="updateStakeInput()"> –ü–æ–¥–∞—Ä–æ–∫</label>
        <input id="tonStake" type="number" min="0.5" step="0.01" placeholder="–°—Ç–∞–≤–∫–∞ TON" style="margin-left:8px; padding:6px;border-radius:6px;">
        <select id="giftStake" style="display:none;margin-left:8px;padding:6px;border-radius:6px;"></select>
        <button onclick="startMines()" style="margin-left:8px;padding:8px 12px;border-radius:8px;background:#2196f3;border:0;color:#fff;font-weight:700;cursor:pointer;">–ò–≥—Ä–∞—Ç—å</button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <div id="mineReward" style="padding:8px;border-radius:8px;border:2px dashed rgba(255,255,255,0.12);">–í—ã–∏–≥—Ä—ã—à: ‚Äì</div>
        <button id="collectReward" onclick="collectReward()" style="padding:8px 12px;border-radius:8px;background:linear-gradient(135deg,#ff9a9e,#fad0c4);border:0;font-weight:700;cursor:pointer;">–ó–∞–±—Ä–∞—Ç—å</button>
      </div>
    </div>

    <div class="grid mines-grid" id="minesGrid"></div>
    <p id="minesStatus" style="margin-top:8px;color:#ffccbc;"></p>
  </main>

  <main id="mine">
    <h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
    <div class="grid" id="mineGrid" style="grid-template-columns:repeat(4,minmax(60px,1fr));"></div>
  </main>

  <main id="inventory">
    <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å üéí</h2>
    <div class="inventory-list" id="inventoryList"></div>
  </main>

  <div class="tab-bar">
    <button id="tab-menu" onclick="showTab('menu')" class="active">–ú–µ–Ω—é</button>
    <button id="tab-mines" onclick="showTab('mines')">–ú–∏–Ω—ã</button>
    <button id="tab-mine" onclick="showTab('mine')">–®–∞—Ö—Ç–∞</button>
    <button id="tab-inventory" onclick="showTab('inventory')">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script>
/* -------------------------
   Configuration & Data
   ------------------------- */

const START_BALANCE = 10000.0;
let balance = START_BALANCE;
const balEl = document.getElementById('balValue');

function updateBalanceUI(){
  balEl.textContent = balance.toFixed(2);
}

/* backgrounds & resources */
const backgrounds = {
  menu: 'images/menu.jpg',
  mines: 'images/mines.jpg',
  mine: 'images/mine.jpg',
  inventory: 'images/inventory.jpg'
};

/* FULL GIFTS LIST (from your input, 'Snake' replaced by "Lunar Snake" and Hypno Lollipop price 1.77) */
const gifts = [
{name:"Hypno Lollipop",price:1.77},{name:"Desk Calendar",price:1.31},{name:"B-Day Candle",price:1.32},
{name:"Lol Pop",price:1.32},{name:"Snake Box",price:1.36},{name:"Lunar Snake",price:1.38},
{name:"Xmas Stocking",price:1.38},{name:"Whip Cupcake",price:1.38},{name:"Candy Cane",price:1.48},
{name:"Pet Snake",price:1.58},{name:"Jester Hat",price:1.62},{name:"Snoop Dogg",price:1.64},
{name:"Homemade Cake",price:1.7},{name:"Holiday Drink",price:1.7},{name:"Jingle Bells",price:1.74},
{name:"Cookie Heart",price:1.75},{name:"Big Year",price:1.78},{name:"Party Sparkler",price:1.8},
{name:"Winter Wreath",price:1.79},{name:"Swag Bag",price:1.91},{name:"Tama Gadget",price:1.93},
{name:"Ginger Cookie",price:1.95},{name:"Moon Pendant",price:1.96},{name:"Jack-in-the-Box",price:2.01},
{name:"Spiced Wine",price:2.12},{name:"Stellar Rocket",price:2.19},{name:"Star Notepad",price:2.32},
{name:"Easter Egg",price:2.46},{name:"Restless Jar",price:2.5},{name:"Santa Hat",price:2.6},
{name:"Snow Globe",price:2.65},{name:"Hex Pot",price:2.7},{name:"Joyful Bundle",price:2.71},
{name:"Lush Bouquet",price:2.84},{name:"Witch Hat",price:2.86},{name:"Light Sword",price:3.13},
{name:"Spy Agaric",price:3.2},{name:"Bow Tie",price:3.22},{name:"Eternal Candle",price:3.38},
{name:"Bunny Muffin",price:3.34},{name:"Jelly Bunny",price:3.43},{name:"Berry Box",price:3.58},
{name:"Evil Eye",price:3.6},{name:"Snow Mittens",price:3.67},{name:"Valentine Box",price:4.2},
{name:"Snoop Cigar",price:4.26},{name:"Sakura Flower",price:4.77},{name:"Hanging Star",price:5.26},
{name:"Jolly Chimp",price:5.34},{name:"Sleigh Bell",price:7.63},{name:"Skull Flower",price:7.7},
{name:"Crystal Ball",price:7.86},{name:"Record Player",price:7.91},{name:"Love Candle",price:7.94},
{name:"Top Hat",price:7.99},{name:"Trapped Heart",price:8.69},{name:"Love Potion",price:8.79},
{name:"Flying Broom",price:9.45},{name:"Cupid Charm",price:11.26},{name:"Eternal Rose",price:13.71},
{name:"Ionic Dryer",price:14.21},{name:"Diamond Ring",price:16.39},{name:"Voodoo Doll",price:16.43},
{name:"Mad Pumpkin",price:17.91},{name:"Toy Bear",price:19.3},{name:"Vintage Cigar",price:23.98},
{name:"Low Rider",price:24.8},{name:"Signet Ring",price:25.1},{name:"Neko Helmet",price:26.41},
{name:"Electric Skull",price:31},{name:"Kissed Frog",price:34},{name:"Swiss Watch",price:35},
{name:"Sharp Tongue",price:39.69},{name:"Scared Cat",price:43.6},{name:"Genie Lamp",price:47.07},
{name:"Westside Sign",price:51.27},{name:"Bonded Ring",price:54.99},{name:"Gem Signet",price:72.98},
{name:"Magic Potion",price:72.98},{name:"Ion Gem",price:83},{name:"Astral Shard",price:95.97},
{name:"Perfume Bottle",price:95.99},{name:"Loot Bag",price:90.1},{name:"Mini Oscar",price:123.89},
{name:"Nail Bracelet",price:129.84},{name:"Heroic Helmet",price:219.99},{name:"Precious Peach",price:379.99},
{name:"Durov‚Äôs Cap",price:794.9},{name:"Heart Locket",price:1450},{name:"Plush Pepe",price:5199}
];

/* Ore types (+ images) */
const oreTypes = [
  {name:'Coal', min:1, max:3, img:'images/ores/coal.png'},
  {name:'Iron', min:3, max:6, img:'images/ores/iron.png'},
  {name:'Gold', min:7, max:10, img:'images/ores/gold.png'},
  {name:'Diamond', min:11, max:15, img:'images/ores/diamond.png'},
  {name:'Emerald', min:15, max:20, img:'images/ores/emerald.png'}
];

/* Inventory & preloaded animations map */
let inventory = [];
const animDataByName = {}; // animation JSON (if available)
const giftImageExists = {}; // map name->bool if png exists

/* Lottie loader reference */
let loaderAnimInstance = null;

/* Some helpers */
function randFloat(min, max){ return Math.round((min + Math.random()*(max-min))*100)/100; }
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

/* choose gift for a block: -50% .. +30% of blockPrice */
function chooseGiftForBlock(blockPrice, preferHigher=false){
  const minP = blockPrice*0.5;
  const maxP = blockPrice*1.3 * 1.10; // +10% extra generosity (as requested)
  // preferHigher: if true, bias toward gifts >= blockPrice
  let pool = gifts.filter(g=>g.price >= minP && g.price <= maxP);
  if(preferHigher){
    const hi = pool.filter(g=>g.price >= blockPrice);
    if(hi.length) pool = pool.concat(hi); // more chance for better
  }
  if(pool.length===0) pool = gifts.slice();
  return pool[Math.floor(Math.random()*pool.length)];
}

/* choose gift for mines reward: aim near reward with +/-30% */
function chooseGiftForReward(value){
  const min = value*0.7;
  const max = value*1.3;
  let pool = gifts.filter(g=>g.price >= min && g.price <= max);
  if(pool.length===0){
    // fallback to nearest by abs diff
    let sorted = gifts.slice().sort((a,b)=>Math.abs(a.price-value)-Math.abs(b.price-value));
    return sorted[0];
  }
  return pool[Math.floor(Math.random()*pool.length)];
}

/* -------------------------
   UI: tabs, stake inputs
   ------------------------- */
function showTab(id){
  document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  // background
  const bg = backgrounds[id] || '';
  if(bg) document.body.style.backgroundImage = `url(${bg})`;
}

function updateStakeInput(){
  const type = document.querySelector('input[name="stakeType"]:checked').value;
  document.getElementById('tonStake').style.display = type==='ton' ? 'inline-block' : 'none';
  document.getElementById('giftStake').style.display = type==='gift' ? 'inline-block' : 'none';
}

/* -------------------------
   PRELOAD: images + animations
   with timeout fallback
   ------------------------- */
const PRELOAD_TIMEOUT_MS = 15000;

function preloadAssets(){
  // show loader immediately (loader is visible by default)
  // start loading backgrounds, gift images, animations
  const imagePromises = [];
  Object.values(backgrounds).forEach(src=>{
    const p = new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res(true);
      img.onerror = ()=>res(false);
      img.src = src;
    });
    imagePromises.push(p);
  });

  // ore images
  oreTypes.forEach(o=>{
    imagePromises.push(new Promise(res=>{
      const img = new Image(); img.onload=()=>res(true); img.onerror=()=>res(false); img.src=o.img;
    }));
  });

  // gift pngs
  const giftImagePromises = gifts.map(g=>{
    return new Promise(res=>{
      const img = new Image();
      img.onload = ()=>{ giftImageExists[g.name]=true; res(true); };
      img.onerror = ()=>{ giftImageExists[g.name]=false; res(false); };
      img.src = `images/gifts/${g.name}.png`;
    });
  });

  // animations (fetch JSON)
  const animationPromises = gifts.map(g=>{
    return fetch(`animations/${g.name}.json`).then(r=>{
      if(!r.ok) return null;
      return r.json().then(json=>{
        animDataByName[g.name] = json;
        return true;
      }).catch(()=>null);
    }).catch(()=>null);
  });

  // loader animation (myLoader.json)
  let loaderAnimPromise = fetch('animations/myLoader.json').then(r=>{
    if(!r.ok) return null;
    return r.json().then(json=>{
      try{
        // initialize loader animation from data (prefer animationData to path)
        loaderAnimInstance = lottie.loadAnimation({
          container: document.getElementById('loaderAnimation'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: json
        });
        return true;
      } catch(e){
        return null;
      }
    }).catch(()=>null);
  }).catch(()=>null);

  const all = [...imagePromises, ...giftImagePromises, ...animationPromises, loaderAnimPromise];

  // safety timeout
  return Promise.race([
    Promise.all(all),
    new Promise(res=>setTimeout(()=>res('timeout'), PRELOAD_TIMEOUT_MS))
  ]).then(res=>{
    // if loaderAnimInstance not set, fallback to a CSS spinner
    if(!loaderAnimInstance){
      document.getElementById('loaderAnimation').innerHTML = '<div class="fallback-spinner" aria-hidden="true"></div>';
      document.getElementById('loaderFallback').style.display='block';
    }
    // return
    return true;
  });
}

/* -------------------------
   SHAFT (mine grid)
   4x4, multi-tap, cooldown
   ------------------------- */
const HITS_TO_BREAK = 5;        // 5 stages as requested
const DECAY_MS = 3000;          // stage decay every 3s if idle
let blockTimers = new Map();    // interval IDs for cooldown timers

function generateMineGrid(){
  const grid = document.getElementById('mineGrid');
  grid.innerHTML = '';
  for(let i=0;i<16;i++){
    const cell = document.createElement('div');
    cell.className = 'block';
    cell.dataset.index = i;
    spawnBlock(cell, i);
    grid.appendChild(cell);
  }
}

function spawnBlock(cell, index = 0){
  // pick ore
  const ore = oreTypes[Math.floor(Math.random()*oreTypes.length)];
  // price random based on ore min/max (float two decimals)
  const price = randFloat(ore.min, ore.max);
  // set visuals
  cell.style.backgroundImage = `url(${ore.img})`;
  cell.dataset.price = price.toFixed(2);
  cell.dataset.hits = 0;
  cell.dataset.cooldown = '0';
  cell.classList.remove('cooldown');
  cell.classList.remove('disabled');

  // render price label
  cell.innerHTML = `<div class="block-price">${price.toFixed(2)} <img src="ton.svg" style="width:12px;vertical-align:middle"></div>`;

  // attach click behavior (multi-tap)
  let decayTimeout = null;
  cell.onclick = (e) => {
    if(cell.classList.contains('cooldown')) return;
    // hits increment
    let hits = parseInt(cell.dataset.hits || '0', 10) + 1;
    cell.dataset.hits = hits;
    // show crack visual (use overlay darkening by stage)
    const stage = clamp(Math.floor(hits), 0, HITS_TO_BREAK);
    cell.style.filter = `brightness(${1 - stage*0.08})`;
    // reset decay timer
    if(decayTimeout) clearTimeout(decayTimeout);
    decayTimeout = setTimeout(()=>{
      // decay one stage every 3s while idle
      let cur = parseInt(cell.dataset.hits||'0',10);
      cur = Math.max(0, cur-1);
      cell.dataset.hits = cur;
      const st = clamp(Math.floor(cur), 0, HITS_TO_BREAK);
      cell.style.filter = `brightness(${1 - st*0.08})`;
    }, DECAY_MS);

    // check break
    if(hits >= HITS_TO_BREAK){
      // final break ‚Äî ensure balance is enough
      const priceVal = parseFloat(cell.dataset.price);
      if(balance < priceVal){
        // not enough to pay for break
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON –¥–ª—è –ø—Ä–æ–±–∏–≤–∞–Ω–∏—è –±–ª–æ–∫–∞ (–Ω—É–∂–Ω–æ: ' + priceVal.toFixed(2) + ')');
        // reset stage visual (let them keep current stage but not allow break)
        cell.dataset.hits = HITS_TO_BREAK - 1;
        const st = clamp(Math.floor(HITS_TO_BREAK-1),0,HITS_TO_BREAK);
        cell.style.filter = `brightness(${1 - st*0.08})`;
        return;
      }
      // pay
      balance -= priceVal;
      updateBalanceUI();

      // choose gift
      const isFirst = (index === 0); // first block bias
      const gift = chooseGiftForBlock(priceVal, isFirst);
      // add to inventory and animate flight
      inventory.push(gift);
      renderInventory();
      animateGiftFlight(gift, cell);

      // put on cooldown
      const cooldownMinutes = Math.floor(1 + Math.random()*30); // 1..30
      const cooldownMs = cooldownMinutes * 60 * 1000;
      startBlockCooldown(cell, cooldownMs, index);
    }
  };
}

function startBlockCooldown(cell, cooldownMs, index=0){
  cell.classList.add('cooldown');
  cell.classList.add('disabled');
  cell.innerHTML = `<div class="cooldown-timer">${Math.ceil(cooldownMs/60000)}m</div>`;
  const endAt = Date.now() + cooldownMs;
  cell.dataset.cooldown = endAt;

  // update timer every second
  if(blockTimers.has(cell)){
    clearInterval(blockTimers.get(cell));
  }
  const iv = setInterval(()=>{
    const now = Date.now();
    const remaining = Math.max(0, endAt - now);
    if(remaining <= 0){
      clearInterval(iv);
      blockTimers.delete(cell);
      // respawn new block (new texture, price)
      spawnBlock(cell, index);
      cell.style.filter = '';
      return;
    }
    const mins = Math.floor(remaining/60000);
    const secs = Math.floor((remaining%60000)/1000);
    const label = mins>0 ? `${mins}m ${secs}s` : `${secs}s`;
    const timerDiv = cell.querySelector('.cooldown-timer');
    if(timerDiv) timerDiv.textContent = label;
  }, 1000);
  blockTimers.set(cell, iv);
}

/* animate gift flight to bottom-right (inventory) */
function animateGiftFlight(gift, fromCell){
  const fromRect = fromCell.getBoundingClientRect();
  const fly = document.createElement('div');
  fly.className = 'flying';
  fly.style.left = (fromRect.left + fromRect.width/2) + 'px';
  fly.style.top = (fromRect.top + fromRect.height/2) + 'px';
  fly.style.width = '80px';
  fly.style.height = '80px';
  fly.style.pointerEvents = 'none';
  document.body.appendChild(fly);

  // if we have animation data -> use lottie to play
  if(animDataByName[gift.name]){
    try{
      const anim = lottie.loadAnimation({
        container: fly,
        renderer: 'svg',
        autoplay: true,
        loop: false,
        animationData: animDataByName[gift.name]
      });
    }catch(e){
      // fallback: use png if exists
      if(giftImageExists[gift.name]){
        fly.innerHTML = `<img src="images/gifts/${gift.name}.png" style="width:100%;height:100%;object-fit:contain">`;
      } else {
        fly.style.background = '#333';
        fly.textContent = gift.name;
      }
    }
  } else if(giftImageExists[gift.name]){
    fly.innerHTML = `<img src="images/gifts/${gift.name}.png" style="width:100%;height:100%;object-fit:contain">`;
  } else {
    fly.style.background = '#333';
    fly.textContent = gift.name;
  }

  // target position: bottom-right near tab bar (above it)
  const targetX = window.innerWidth - 80 - 16; // 16px margin
  const targetY = window.innerHeight - 120; // above tabbar
  // animate using CSS transitions
  fly.animate([
    { transform: 'translate(0,0) scale(1)', opacity: 1 },
    { transform: `translate(${targetX - (fromRect.left + fromRect.width/2)}px, ${targetY - (fromRect.top + fromRect.height/2)}px) scale(0.5)`, opacity: 0.9 }
  ], { duration: 1000, easing: 'cubic-bezier(.2,.8,.2,1)' });

  setTimeout(()=>{ try{ fly.remove(); }catch(e){} }, 1050);
}

/* -------------------------
   Inventory UI
   ------------------------- */
function renderInventory(){
  const list = document.getElementById('inventoryList');
  list.innerHTML = '';
  inventory.forEach((gift, idx)=>{
    const item = document.createElement('div');
    item.className = 'gift-item';
    // preview div
    const preview = document.createElement('div');
    preview.className = 'gift-preview';
    preview.style.display = 'flex';
    preview.style.alignItems = 'center';
    preview.style.justifyContent = 'center';
    preview.style.background = 'rgba(255,255,255,0.02)';
    preview.style.borderRadius = '8px';

    // if png exists, show png; else if animation JSON available - render first frame
    if(giftImageExists[gift.name]){
      const img = document.createElement('img');
      img.src = `images/gifts/${gift.name}.png`;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      preview.appendChild(img);
    } else if(animDataByName[gift.name]){
      // use lottie and freeze to first frame to avoid heavy loops
      try{
        const anim = lottie.loadAnimation({
          container: preview,
          renderer: 'svg',
          loop: false,
          autoplay: false,
          animationData: animDataByName[gift.name]
        });
        // go to first frame & stop (fast)
        anim.goToAndStop(0, true);
      }catch(e){
        preview.textContent = gift.name;
      }
    } else {
      preview.textContent = gift.name;
    }

    const info = document.createElement('div');
    info.className = 'gift-info';
    info.innerHTML = `${gift.name}<br><small>${gift.price.toFixed(2)} <img src="ton.svg" style="width:12px;vertical-align:middle"></small>`;

    const actions = document.createElement('div');
    actions.className = 'gift-actions';
    const sell = document.createElement('button');
    sell.className = 'sell';
    sell.textContent = '–ü—Ä–æ–¥–∞—Ç—å';
    sell.onclick = ()=>{
      // sell: remove and credit balance
      inventory.splice(idx,1);
      balance += gift.price;
      updateBalanceUI();
      renderInventory();
    };
    const withdraw = document.createElement('button');
    withdraw.className = 'withdraw';
    withdraw.textContent = '–í—ã–≤–µ—Å—Ç–∏';
    withdraw.onclick = ()=> alert('–í—ã–≤–æ–¥ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∑–∂–µ.');

    actions.appendChild(sell);
    actions.appendChild(withdraw);

    item.appendChild(preview);
    item.appendChild(info);
    item.appendChild(actions);
    list.appendChild(item);
  });
}

/* -------------------------
   MINES logic (5x5)
   ------------------------- */
let minesState = {
  active: false,
  lost: false,
  minePositions: new Set(),
  revealed: new Set(),
  currentStake: 0,
  multiplier: 1.0
};

function generateMinesBoard(){
  const grid = document.getElementById('minesGrid');
  grid.innerHTML = '';
  for(let i=0;i<25;i++){
    const cell = document.createElement('div');
    cell.className = 'mine-cell disabled';
    cell.dataset.index = i;
    grid.appendChild(cell);
  }
}

function startMines(){
  const type = document.querySelector('input[name="stakeType"]:checked').value;
  if(minesState.active){
    alert('–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞');
    return;
  }
  // prepare board & mines
  minesState = { active:true, lost:false, minePositions:new Set(), revealed:new Set(), currentStake:0, multiplier:1.0 };
  while(minesState.minePositions.size < 5){
    minesState.minePositions.add(Math.floor(Math.random()*25));
  }

  // obtain stake
  if(type === 'ton'){
    const stakeVal = parseFloat(document.getElementById('tonStake').value);
    if(!stakeVal || stakeVal < 0.5){ alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É >= 0.5 TON'); return; }
    if(balance < stakeVal){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
    balance -= stakeVal; updateBalanceUI();
    minesState.currentStake = stakeVal;
  } else {
    // gift stake (must choose gift)
    const sel = document.getElementById('giftStake');
    const name = sel.value;
    if(!name){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è —Å—Ç–∞–≤–∫–∏'); return; }
    // remove that gift from inventory
    const idx = inventory.findIndex(g=>g.name === name);
    if(idx === -1){ alert('–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); return; }
    const gift = inventory.splice(idx,1)[0];
    renderInventory();
    minesState.currentStake = gift.price; // stake value in TON-equivalent
  }

  // show board active
  const cells = document.querySelectorAll('#minesGrid .mine-cell');
  cells.forEach((c, i)=>{
    c.classList.remove('revealed','mine','safe','disabled');
    c.onclick = ()=>revealMineCell(i);
  });
  document.getElementById('mineReward').textContent = '–í—ã–∏–≥—Ä—ã—à: 0';
  document.getElementById('minesStatus').textContent = '';
}

function revealMineCell(i){
  if(!minesState.active || minesState.lost) return;
  const idx = i;
  const grid = document.getElementById('minesGrid');
  const cell = grid.children[idx];
  if(!cell || cell.classList.contains('revealed')) return;
  cell.classList.add('revealed');

  if(minesState.minePositions.has(idx)){
    // exploded
    cell.classList.add('mine');
    minesState.active = false;
    minesState.lost = true;
    // reveal all mines
    const cells = grid.children;
    minesState.minePositions.forEach(mi=>{
      if(cells[mi]) cells[mi].classList.add('mine');
    });
    document.getElementById('minesStatus').textContent = 'üí• –ë—É–º! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.';
    document.getElementById('mineReward').textContent = '–í—ã–∏–≥—Ä—ã—à: –ü–†–û–ò–ì–†–´–®';
  } else {
    cell.classList.add('safe');
    // increase multiplier (example: +0.1 each safe click)
    minesState.multiplier += 0.1;
    const estimated = minesState.currentStake * minesState.multiplier;
    document.getElementById('mineReward').textContent = `–í—ã–∏–≥—Ä—ã—à: ${estimated.toFixed(2)}`;
  }
}

function collectReward(){
  if(minesState.lost){ alert('–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ.'); return; }
  if(!minesState.active){ alert('–ò–≥—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.'); return; }
  const estimated = minesState.currentStake * minesState.multiplier;
  if(estimated <= 0.0001){ alert('–ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞'); return; }
  if(estimated >= 1.5){
    // give gift instead of TON
    const gift = chooseGiftForReward(estimated);
    inventory.push(gift);
    renderInventory();
    alert('–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫: ' + gift.name);
  } else {
    balance += estimated;
    updateBalanceUI();
    alert('–í—ã –ø–æ–ª—É—á–∏–ª–∏ ' + estimated.toFixed(2) + ' TON');
  }
  // finish game
  minesState = { active:false, lost:false, minePositions:new Set(), revealed:new Set(), currentStake:0, multiplier:1.0 };
  // regenerate grid (disable cells)
  const cells = document.querySelectorAll('#minesGrid .mine-cell');
  cells.forEach(c=>{ c.classList.add('disabled'); c.onclick = null; });
  document.getElementById('mineReward').textContent = '–í—ã–∏–≥—Ä—ã—à: ‚Äì';
  document.getElementById('minesStatus').textContent = 'üéâ –ó–∞–±—Ä–∞–Ω–æ!';
}

/* -------------------------
   Init & Preload + hookup
   ------------------------- */

(function init(){
  updateBalanceUI();
  // initial UI state
  document.getElementById('tonStake').value = '';
  updateStakeInput();
  generateMinesBoard();

  // prefill gift selection
  const giftSel = document.getElementById('giftStake');
  giftSel.innerHTML = '';
  gifts.forEach(g=>{
    const o = document.createElement('option');
    o.value = g.name;
    o.textContent = `${g.name} (${g.price.toFixed(2)} TON)`;
    giftSel.appendChild(o);
  });

  // preload assets then show UI
  preloadAssets().then(()=> {
    // hide loader
    const loader = document.getElementById('loader');
    loader.classList.add('hidden');
    // show mains
    document.querySelectorAll('main').forEach(m=>m.classList.add('active'));
    // generate mine grid now
    generateMineGrid();
    generateMinesBoard();
    renderInventory(); // empty initially
    // set body background if available
    if(backgrounds.menu) document.body.style.backgroundImage = `url(${backgrounds.menu})`;
  }).catch(err=>{
    console.error('preload error', err);
    // still hide loader after fail-safe
    document.getElementById('loader').classList.add('hidden');
    document.querySelectorAll('main').forEach(m=>m.classList.add('active'));
  });

  // safe click small helpers
  document.getElementById('collectReward').addEventListener('click', collectReward);
  // tab initial
  showTab('menu');
})();

</script>
</body>
</html>
