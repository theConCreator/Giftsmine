<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>MineGame</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #fff;
      overflow: hidden;
    }
    #app {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      flex: 0 0 50px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #222;
    }
    header button {
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 8px;
      color: #fff;
      padding: 8px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    header button:hover {
      background: rgba(255,255,255,0.15);
    }
    main {
      flex: 1;
      overflow: auto;
      position: relative;
    }
    .hidden { display: none; }
    #loader {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #loaderProgress {
      width: 60%;
      height: 12px;
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 20px;
    }
    #loaderProgressBar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.2s;
    }
    /* Меню */
    #menu {
      width: 100%;
      height: 100%;
      background: url('backgrounds/menu.jpg') center/cover no-repeat;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #menuBanner {
      width: 80%;
      aspect-ratio: 5 / 1;
      background: rgba(0,0,0,0.5);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      color: #fff;
      font-size: 1.2em;
    }
    /* Шахта */
    #mineGrid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      padding: 10px;
    }
    .block {
      position: relative;
      aspect-ratio: 1;
      background-size: cover;
      background-position: center;
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
    }
    .block.disabled {
      background-color: rgba(0,0,0,0.5);
      pointer-events: none;
    }
    .priceTag, .timerTag {
      position: absolute;
      background: rgba(0,0,0,0.6);
      padding: 2px 5px;
      border-radius: 6px;
      font-size: 0.7em;
    }
    .priceTag {
      bottom: 4px;
      right: 4px;
    }
    .timerTag {
      top: 4px;
      left: 4px;
    }
    .breakStage {
      position: absolute;
      inset: 0;
      background-repeat: no-repeat;
      background-position: center;
      background-size: cover;
      image-rendering: pixelated;
      pointer-events: none;
    }
    /* Инвентарь */
    #inventoryList {
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .giftCard {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 10px;
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .giftActions button {
      margin: 4px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 4px 8px;
      cursor: pointer;
    }
    /* Баланс */
    #balanceSection {
      padding: 12px;
    }
    .balanceCard {
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .depositButton {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 6px 0;
      width: 100%;
      cursor: pointer;
    }
    .depositButton img {
      width: 20px;
      margin-right: 10px;
    }
    #transactionHistory {
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="loader">
    <div id="loaderAnimation"></div>
    <div id="loaderProgress">
      <div id="loaderProgressBar"></div>
    </div>
  </div>
  <div id="app">
    <header>
      <button onclick="showTab('menu')">Меню</button>
      <button onclick="showTab('mine')">Шахта</button>
      <button onclick="showTab('inventory')">Инвентарь</button>
      <button onclick="showTab('balance')">Баланс</button>
    </header>
    <main>
      <section id="menu">
        <div id="menuBanner">Рекламный баннер</div>
      </section>
      <section id="mine" class="hidden">
        <div id="mineGrid"></div>
      </section>
      <section id="inventory" class="hidden">
        <div id="inventoryList"></div>
      </section>
      <section id="balance" class="hidden">
        <div id="balanceSection">
          <div class="balanceCard">
            <h3>Пополнение</h3>
            <button class="depositButton" onclick="addBalance('ton')">
              <span><img src="icons/ton.svg"> TON кошелёк</span>
              <span>0% комиссия</span>
            </button>
            <button class="depositButton" onclick="addBalance('crypto')">
              <span><img src="icons/cryptobot.svg"> Crypto bot</span>
              <span>5% комиссия</span>
            </button>
            <button class="depositButton" onclick="addBalance('stars')">
              <span><img src="icons/stars.svg"> Telegram Stars</span>
              <span>20% комиссия</span>
            </button>
          </div>
          <div class="balanceCard">
            <h3>Промокод</h3>
            <input id="promoCode" placeholder="Введите промокод">
            <button onclick="redeemPromo()">Активировать</button>
          </div>
          <div class="balanceCard">
            <h3>Реферальная программа</h3>
            <p>+0.5% с депозита за каждый сломанный блок (макс. 20%).</p>
            <p id="refPercent">Текущий бонус: 1%</p>
          </div>
          <div class="balanceCard">
            <h3>История операций</h3>
            <div id="transactionHistory"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
  <script>
    let balance = 100;
    let inventory = [];
    let transactions = [];
    let brokenBlocks = 0;
    let refPercent = 1;
    const gifts = [
      {name:"Hypno Lollipop",price:1.77}, {name:"Desk Calendar",price:1.31},
      {name:"B-Day Candle",price:1.32}, {name:"Lol Pop",price:1.32},
      {name:"Lunar Snake",price:1.38}, {name:"Snake Box",price:1.36},
      {name:"Xmas Stocking",price:1.38}, {name:"Whip Cupcake",price:1.38},
      {name:"Candy Cane",price:1.48}, {name:"Pet Snake",price:1.58},
      {name:"Jester Hat",price:1.62}, {name:"Snoop Dogg",price:1.64},
      {name:"Homemade Cake",price:1.7}, {name:"Holiday Drink",price:1.7},
      {name:"Jingle Bells",price:1.74}, {name:"Cookie Heart",price:1.75},
      {name:"Big Year",price:1.78}, {name:"Party Sparkler",price:1.8},
      {name:"Winter Wreath",price:1.79}, {name:"Swag Bag",price:1.91},
      {name:"Tama Gadget",price:1.93}, {name:"Ginger Cookie",price:1.95},
      {name:"Moon Pendant",price:1.96}, {name:"Jack-in-the-Box",price:2.01},
      {name:"Spiced Wine",price:2.12}, {name:"Stellar Rocket",price:2.19},
      {name:"Star Notepad",price:2.32}, {name:"Easter Egg",price:2.46},
      {name:"Restless Jar",price:2.5}, {name:"Santa Hat",price:2.6},
      {name:"Snow Globe",price:2.65}, {name:"Hex Pot",price:2.7},
      {name:"Joyful Bundle",price:2.71}, {name:"Lush Bouquet",price:2.84},
      {name:"Witch Hat",price:2.86}, {name:"Light Sword",price:3.13},
      {name:"Spy Agaric",price:3.2}, {name:"Bow Tie",price:3.22},
      {name:"Eternal Candle",price:3.38}, {name:"Bunny Muffin",price:3.34},
      {name:"Jelly Bunny",price:3.43}, {name:"Berry Box",price:3.58},
      {name:"Evil Eye",price:3.6}, {name:"Snow Mittens",price:3.67},
      {name:"Valentine Box",price:4.2}, {name:"Snoop Cigar",price:4.26},
      {name:"Sakura Flower",price:4.77}, {name:"Hanging Star",price:5.26},
      {name:"Jolly Chimp",price:5.34}, {name:"Sleigh Bell",price:7.63},
      {name:"Skull Flower",price:7.7}, {name:"Crystal Ball",price:7.86},
      {name:"Record Player",price:7.91}, {name:"Love Candle",price:7.94},
      {name:"Top Hat",price:7.99}, {name:"Trapped Heart",price:8.69},
      {name:"Love Potion",price:8.79}, {name:"Flying Broom",price:9.45},
      {name:"Cupid Charm",price:11.26}, {name:"Eternal Rose",price:13.71},
      {name:"Ionic Dryer",price:14.21}, {name:"Diamond Ring",price:16.39},
      {name:"Voodoo Doll",price:16.43}, {name:"Mad Pumpkin",price:17.91},
      {name:"Toy Bear",price:19.3}, {name:"Vintage Cigar",price:23.98},
      {name:"Low Rider",price:24.8}, {name:"Signet Ring",price:25.1},
      {name:"Neko Helmet",price:26.41}, {name:"Electric Skull",price:31},
      {name:"Kissed Frog",price:34}, {name:"Swiss Watch",price:35},
      {name:"Sharp Tongue",price:39.69}, {name:"Scared Cat",price:43.6},
      {name:"Genie Lamp",price:47.07}, {name:"Westside Sign",price:51.27},
      {name:"Bonded Ring",price:54.99}, {name:"Gem Signet",price:72.98},
      {name:"Magic Potion",price:72.98}, {name:"Ion Gem",price:83},
      {name:"Astral Shard",price:95.97}, {name:"Perfume Bottle",price:95.99},
      {name:"Loot Bag",price:90.1}, {name:"Mini Oscar",price:123.89},
      {name:"Nail Bracelet",price:129.84}, {name:"Heroic Helmet",price:219.99},
      {name:"Precious Peach",price:379.99}, {name:"Durov’s Cap",price:794.9},
      {name:"Heart Locket",price:1450}, {name:"Plush Pepe",price:5199}
    ];
    const blocks = ["coal","iron","gold","diamond","emerald","earth","glass"];

    function showTab(id){
      document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function updateBalance(){
      document.querySelector("header").children[3].textContent = "Баланс: "+balance.toFixed(2)+" TON";
    }
    function updateTransactionHistory(){
      document.getElementById("transactionHistory").innerHTML = transactions.map(t=>"<div>"+t+"</div>").join("");
    }
    function updateRefPercent(){
      document.getElementById("refPercent").textContent = "Текущий бонус: "+refPercent.toFixed(1)+"%";
    }

    function generateMineGrid(){
      const grid=document.getElementById("mineGrid");
      grid.innerHTML="";
      for(let i=0;i<20;i++){
        const block=document.createElement("div");
        block.className="block";
        const type=blocks[Math.floor(Math.random()*blocks.length)];
        block.dataset.type=type;
        block.style.backgroundImage=`url(blocks/${type}.png)`;
        const price=type==="earth"?1:Math.floor(Math.random()*20)+1;
        block.dataset.price=price;
        const priceTag=document.createElement("div");
        priceTag.className="priceTag";
        priceTag.textContent=price+" TON";
        block.appendChild(priceTag);
        block.onclick=()=>mineBlock(block);
        grid.appendChild(block);
      }
    }

    function mineBlock(block){
      const price=parseFloat(block.dataset.price);
      if(balance<price){alert("Недостаточно средств!");return;}
      balance-=price;updateBalance();
      transactions.unshift("Списано "+price+" TON за ломание блока");
      updateTransactionHistory();
      block.classList.add("disabled");
      const timer=document.createElement("div");
      timer.className="timerTag";
      timer.textContent="5с";
      block.appendChild(timer);
      let t=5;
      const interval=setInterval(()=>{
        t--;timer.textContent=t+"с";
        if(t<=0){clearInterval(interval);block.classList.remove("disabled");generateMineGrid();}
      },1000);
      brokenBlocks++;if(refPercent<20)refPercent+=0.5;updateRefPercent();
    }

    function addBalance(method){
      let amount=100;let fee=0;
      if(method==="crypto") fee=0.05;
      if(method==="stars") fee=0.20;
      let final=amount*(1-fee);
      balance+=final;updateBalance();
      transactions.unshift("Пополнение "+final+" TON через "+method);
      updateTransactionHistory();
    }
    function redeemPromo(){
      const code=document.getElementById("promoCode").value.trim();
      if(code==="BONUS10"){balance+=10;updateBalance();transactions.unshift("Промокод +10 TON");}
      else{transactions.unshift("Неверный промокод");}
      updateTransactionHistory();
    }

    async function preload(){
      const files=[...blocks.map(b=>"blocks/"+b+".png"),...Array.from({length:10},(_,i)=>"destroy/destroy_stage_"+i+".png"),...gifts.map(g=>"emoji/"+g.name+".json"),"backgrounds/menu.jpg","icons/ton.svg","icons/cryptobot.svg","icons/stars.svg","ton.svg"];
      let loaded=0;
      for(const f of files){
        try{
          if(f.endsWith(".json")){
            await fetch(f).then(r=>{if(!r.ok)throw 0;return r.json();});
          }else{
            await new Promise((res,rej)=>{const img=new Image();img.onload=res;img.onerror=res;img.src=f;});
          }
        }catch{}
        loaded++;document.getElementById("loaderProgressBar").style.width=(loaded/files.length*100)+"%";
      }
    }
    async function init(){
      lottie.loadAnimation({container:document.getElementById("loaderAnimation"),renderer:"svg",loop:true,autoplay:true,path:"myLoader.json"});
      await preload();
      document.getElementById("loader").classList.add("hidden");
      generateMineGrid();
      updateBalance();
      updateTransactionHistory();
      updateRefPercent();
    }
    init();
  </script>
</body>
</html>
