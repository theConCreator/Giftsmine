<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiftsMine üéÅ</title>
<style>
  /* --- –®—Ä–∏—Ñ—Ç—ã –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
  @font-face{ font-family:'Minecraft'; src:url('minecraft.ttf') format('truetype'); }
  :root{
    --bg: #060608;
    --card: rgba(20,20,20,0.9);
    --accent1: linear-gradient(135deg,#ff9a9e,#fad0c4);
    --accent2: linear-gradient(135deg,#a1c4fd,#c2e9fb);
    --blue: linear-gradient(135deg,#6a11cb,#2575fc);
  }
  html,body{height:100%;margin:0;font-family:'Minecraft',sans-serif;background:var(--bg);color:#fff;}
  body{display:flex;flex-direction:column;overflow:hidden;background-size:cover;background-position:center;transition:background 0.5s;}
  #balance{padding:14px 18px;text-align:right;background:rgba(0,0,0,0.14);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,0.45);font-weight:700;}
  main{flex:1;overflow:auto;padding:18px 16px 92px 16px;display:none;background:linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.25));}
  main.active{display:block;}
  h2{margin:0 0 12px 0;text-align:center;font-size:1.35rem;}
  /* banner */
  .banner{width:100%;aspect-ratio:5/1;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.5);margin-bottom:14px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03)}
  .banner img{width:100%;height:100%;object-fit:cover;display:block}
  /* tab bar */
  .tab-bar{position:fixed;bottom:12px;left:12px;right:12px;display:flex;gap:10px;padding:10px;background:rgba(0,0,0,0.18);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:999}
  .tab-bar button{flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;background:var(--accent1);color:#fff;font-weight:800;box-shadow:0 6px 16px rgba(0,0,0,0.35)}
  .tab-bar button.active{background:var(--accent2)}
  /* mine grid */
  .grid{display:grid;grid-template-columns:repeat(4,minmax(64px,1fr));gap:8px;align-items:stretch}
  .block{position:relative;height:0;padding-bottom:100%;background:#333;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:inset 0 -10px 30px rgba(0,0,0,0.4)}
  .block img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
  .block-price{position:absolute;right:6px;bottom:6px;background:rgba(0,0,0,0.6);padding:4px 6px;border-radius:6px;font-size:0.75rem;display:flex;gap:6px;align-items:center}
  .block.cooldown{filter:brightness(0.55);cursor:default}
  /* canvas pixel */
  canvas.pixelated{width:100%;height:100%;image-rendering:pixelated;display:block}
  /* inventory */
  .inventory-list{display:flex;flex-direction:column;gap:12px}
  .gift-item{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);display:flex;flex-direction:column}
  .gift-top{display:flex;gap:12px;align-items:center}
  .gift-preview{width:64px;height:64px;border-radius:8px;overflow:hidden;background:#0b0b0b;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:#ddd}
  .gift-info{flex:1;display:flex;flex-direction:column;gap:6px}
  .gift-name{font-weight:800}
  .gift-price{color:#bbb;font-size:0.9rem}
  .gift-actions{display:flex;gap:10px;margin-top:10px}
  .btn{border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--accent1);color:#fff}
  .btn.secondary{background:var(--blue);color:#fff}
  /* balance tab */
  .deposit-option{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);margin-bottom:10px;cursor:pointer}
  .deposit-left{display:flex;align-items:center;gap:10px}
  .deposit-left img{width:26px;height:26px}
  .deposit-percent{font-size:0.85rem;color:#cfd6ff;text-align:right}
  .small{font-size:0.85rem;color:#bbb}
  /* loader */
  #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000;z-index:2000}
  #loader.hidden{opacity:0;pointer-events:none;transition:opacity .6s}
  #loaderAnimation{width:260px;height:260px;margin-bottom:14px}
  #loaderProgress{width:40%;height:12px;background:#222;border-radius:12px;overflow:hidden}
  #loaderProgressBar{width:0%;height:100%;background:#7c3cff;transition:width .25s}
  /* tiny */
  .muted{color:#aeb2bb;font-size:0.85rem}
  @media (max-width:700px){
    .grid{grid-template-columns:repeat(4,1fr);gap:6px}
    .tab-bar{left:8px;right:8px;bottom:8px}
    #loaderAnimation{width:180px;height:180px}
  }
</style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div id="loaderAnimation"></div>
    <div id="loaderProgress"><div id="loaderProgressBar"></div></div>
    <div class="muted" style="margin-top:8px">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</div>
  </div>

  <!-- top balance -->
  <div id="balance">–ë–∞–ª–∞–Ω—Å: 0 <img src="ton.svg" style="width:16px;vertical-align:middle"></div>

  <!-- MAIN TABS -->
  <main id="menu" class="active">
    <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <a class="banner" href="#" target="_blank"><img src="images/menu.jpg" alt="banner"></a>
    <p class="muted" style="text-align:center;margin-top:12px">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–∏—Ä–∞–π—Ç–µ —Ä–µ–∂–∏–º –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –∫–æ–ø–∞—Ç—å üéÅ</p>
  </main>

  <main id="mine">
    <h2>–®–∞—Ö—Ç–∞ ‚õèÔ∏è</h2>
    <div class="small" id="brokenBlocks" style="text-align:center;margin-bottom:10px">–°–ª–æ–º–∞–Ω–æ –±–ª–æ–∫–æ–≤: 0</div>
    <div class="grid" id="mineGrid"></div>
  </main>

  <main id="inventory">
    <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å üéí</h2>
    <div class="inventory-list" id="inventoryList"></div>
  </main>

  <main id="balanceTab">
    <h2>–ë–∞–ª–∞–Ω—Å üí∞</h2>

    <div style="margin-bottom:12px">
      <div class="deposit-option" onclick="addBalancePrompt('TON')">
        <div class="deposit-left"><img src="ton.svg" alt="ton"><div><strong>TON –∫–æ—à–µ–ª—ë–∫</strong><div class="muted">–±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ</div></div></div>
        <div class="deposit-percent"><div class="muted">–∫–æ–º–∏—Å—Å–∏—è</div><strong>0%</strong></div>
      </div>

      <div class="deposit-option" onclick="addBalancePrompt('CryptoBot')">
        <div class="deposit-left"><img src="icons/cryptobot.svg" alt="cryptobot"><div><strong>Crypto Bot</strong><div class="muted">–æ–ø–ª–∞—Ç–∞ –±–æ—Ç–æ–º</div></div></div>
        <div class="deposit-percent"><div class="muted">–∫–æ–º–∏—Å—Å–∏—è</div><strong>5%</strong></div>
      </div>

      <div class="deposit-option" onclick="addBalancePrompt('Stars')">
        <div class="deposit-left"><img src="icons/star.svg" alt="stars"><div><strong>Telegram Stars</strong><div class="muted">–ø–æ–¥–∞—Ä–∫–∏ –∏ –∑–≤–µ–∑–¥—ã</div></div></div>
        <div class="deposit-percent"><div class="muted">–∫–æ–º–∏—Å—Å–∏—è</div><strong>20%</strong></div>
      </div>
    </div>

    <div style="margin-bottom:12px">
      <h3 style="margin:0 0 6px 0">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
      <p class="muted">–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <strong id="refPercent">1%</strong> –±–æ–Ω—É—Å–∞ –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ +0.5% –∑–∞ –∫–∞–∂–¥—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–º–∞–∫—Å 20%).</p>
    </div>

    <div style="margin-bottom:12px">
      <h3 style="margin:0 0 6px 0">–ü—Ä–æ–º–æ–∫–æ–¥</h3>
      <div style="display:flex;gap:8px"><input id="promoCode" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"><button class="btn primary" onclick="redeemPromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button></div>
    </div>

    <div>
      <h3 style="margin:6px 0">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
      <div id="transactionHistory" class="muted" style="max-height:260px;overflow:auto;padding-right:6px"></div>
    </div>
  </main>

  <!-- tab bar -->
  <div class="tab-bar" role="tablist">
    <button id="tab-menu" class="active" onclick="showTab('menu')">–ú–µ–Ω—é</button>
    <button id="tab-mine" onclick="showTab('mine')">–®–∞—Ö—Ç–∞</button>
    <button id="tab-inventory" onclick="showTab('inventory')">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
    <button id="tab-balanceTab" onclick="showTab('balanceTab')">–ë–∞–ª–∞–Ω—Å</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
  <script>
  /* -------------------------
     GAME STATE & ASSETS
     -------------------------*/
  let balance = 1000.00;
  let transactions = []; // newest first (unshift)
  let inventory = [];
  let brokenBlocks = 0;
  let refPercent = 1.0; // shown percent (from deposits)
  const MAX_REF = 20.0;

  const backgrounds = {
    menu: 'images/menu.jpg',
    mine: 'images/mine.jpg',
    inventory: 'images/inventory.jpg',
    balanceTab: 'images/mobs.jpg'
  };

  // full list of gifts (copied from your earlier list)
  const gifts = [
{name:"Hypno Lollipop",price:1.77},{name:"Desk Calendar",price:1.31},{name:"B-Day Candle",price:1.32},{name:"Lol Pop",price:1.32},{name:"Lunar Snake",price:1.38},{name:"Snake Box",price:1.36},{name:"Xmas Stocking",price:1.38},{name:"Whip Cupcake",price:1.38},{name:"Candy Cane",price:1.48},{name:"Pet Snake",price:1.58},{name:"Jester Hat",price:1.62},{name:"Snoop Dogg",price:1.64},{name:"Homemade Cake",price:1.7},{name:"Holiday Drink",price:1.7},{name:"Jingle Bells",price:1.74},{name:"Cookie Heart",price:1.75},{name:"Big Year",price:1.78},{name:"Party Sparkler",price:1.8},{name:"Winter Wreath",price:1.79},{name:"Swag Bag",price:1.91},{name:"Tama Gadget",price:1.93},{name:"Ginger Cookie",price:1.95},{name:"Moon Pendant",price:1.96},{name:"Jack-in-the-Box",price:2.01},{name:"Spiced Wine",price:2.12},{name:"Stellar Rocket",price:2.19},{name:"Star Notepad",price:2.32},{name:"Easter Egg",price:2.46},{name:"Restless Jar",price:2.5},{name:"Santa Hat",price:2.6},{name:"Snow Globe",price:2.65},{name:"Hex Pot",price:2.7},{name:"Joyful Bundle",price:2.71},{name:"Lush Bouquet",price:2.84},{name:"Witch Hat",price:2.86},{name:"Light Sword",price:3.13},{name:"Spy Agaric",price:3.2},{name:"Bow Tie",price:3.22},{name:"Eternal Candle",price:3.38},{name:"Bunny Muffin",price:3.34},{name:"Jelly Bunny",price:3.43},{name:"Berry Box",price:3.58},{name:"Evil Eye",price:3.6},{name:"Snow Mittens",price:3.67},{name:"Valentine Box",price:4.2},{name:"Snoop Cigar",price:4.26},{name:"Sakura Flower",price:4.77},{name:"Hanging Star",price:5.26},{name:"Jolly Chimp",price:5.34},{name:"Sleigh Bell",price:7.63},{name:"Skull Flower",price:7.7},{name:"Crystal Ball",price:7.86},{name:"Record Player",price:7.91},{name:"Love Candle",price:7.94},{name:"Top Hat",price:7.99},{name:"Trapped Heart",price:8.69},{name:"Love Potion",price:8.79},{name:"Flying Broom",price:9.45},{name:"Cupid Charm",price:11.26},{name:"Eternal Rose",price:13.71},{name:"Ionic Dryer",price:14.21},{name:"Diamond Ring",price:16.39},{name:"Voodoo Doll",price:16.43},{name:"Mad Pumpkin",price:17.91},{name:"Toy Bear",price:19.3},{name:"Vintage Cigar",price:23.98},{name:"Low Rider",price:24.8},{name:"Signet Ring",price:25.1},{name:"Neko Helmet",price:26.41},{name:"Electric Skull",price:31},{name:"Kissed Frog",price:34},{name:"Swiss Watch",price:35},{name:"Sharp Tongue",price:39.69},{name:"Scared Cat",price:43.6},{name:"Genie Lamp",price:47.07},{name:"Westside Sign",price:51.27},{name:"Bonded Ring",price:54.99},{name:"Gem Signet",price:72.98},{name:"Magic Potion",price:72.98},{name:"Ion Gem",price:83},{name:"Astral Shard",price:95.97},{name:"Perfume Bottle",price:95.99},{name:"Loot Bag",price:90.1},{name:"Mini Oscar",price:123.89},{name:"Nail Bracelet",price:129.84},{name:"Heroic Helmet",price:219.99},{name:"Precious Peach",price:379.99},{name:"Durov‚Äôs Cap",price:794.9},{name:"Heart Locket",price:1450},{name:"Plush Pepe",price:5199}
  ];

  // ore types
  const oreTypes = [
    {img:'images/ores/coal.png', hits:3},
    {img:'images/ores/iron.png', hits:4},
    {img:'images/ores/gold.png', hits:5},
    {img:'images/ores/diamond.png', hits:6},
    {img:'images/ores/emerald.png', hits:7}
  ];

  // map for lottie blob URLs (filled during preload)
  const animationMap = {};

  /* -------------------------
     HELPERS & UI updates
     -------------------------*/
  function updateBalanceUI(){
    document.getElementById('balance').innerHTML = `–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} <img src="ton.svg" style="width:16px;vertical-align:middle">`;
  }
  function updateTransactionsUI(){
    const el = document.getElementById('transactionHistory');
    el.innerHTML = '';
    // transactions already newest-first (unshift), show as-is
    transactions.forEach(t=>{
      const d = document.createElement('div');
      d.textContent = t;
      d.style.padding = '6px 0';
      el.appendChild(d);
    });
  }
  function updateBrokenUI(){
    document.getElementById('brokenBlocks').textContent = `–°–ª–æ–º–∞–Ω–æ –±–ª–æ–∫–æ–≤: ${brokenBlocks}`;
  }
  function updateRefUI(){ document.getElementById('refPercent').textContent = refPercent.toFixed(1) + '%'; }

  /* -------------------------
     TAB SWITCH
     -------------------------*/
  function showTab(id){
    document.querySelectorAll('main').forEach(m=>m.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    if(backgrounds[id]) document.body.style.backgroundImage = `url(${backgrounds[id]})`;
    if(id==='inventory') renderInventory();
  }

  /* -------------------------
     GIFT SELECTION (EV bias)
     Goal: small positive expected return for player.
     Strategy: filter gifts in range [0.5*price,1.45*price], then weight probability by gift.price^alpha
     tuning alpha>0 biases toward expensive gifts, increasing EV.
     -------------------------*/
  function getGiftByPrice(price){
    const min = price*0.5, max = price*1.45;
    let candidate = gifts.filter(g => g.price >= min && g.price <= max);
    if(candidate.length === 0) candidate = gifts.slice();
    // weight by price^alpha to bias upward (alpha ~ 0.6 gives modest positive EV)
    const alpha = 0.6;
    const weights = candidate.map(g => Math.pow(g.price, alpha));
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for(let i=0;i<candidate.length;i++){
      r -= weights[i];
      if(r <= 0) return candidate[i];
    }
    return candidate[candidate.length-1];
  }

  /* -------------------------
     MINE: spawn block, handle hits, pixelated destroy frames
     Rules:
      - On first click we check balance >= price. If not: do nothing & notify.
      - Price is charged only when block fully broken (not per click).
      - Destroy frames shown on canvas with image-rendering: pixelated
      - Frame selection: evenly distribute 0..9 across hits (e.g., hits=3 => [0,4,9] approx)
     -------------------------*/
  function spawnBlock(cell, index=0){
    // choose ore & price
    const ore = oreTypes[Math.floor(Math.random()*oreTypes.length)];
    const price = +(1 + Math.random()*10).toFixed(2);

    // prepare element
    cell.className = 'block';
    cell.style.backgroundImage = `url(${ore.img})`;
    cell.innerHTML = ''; // clear
    const priceEl = document.createElement('div');
    priceEl.className = 'block-price';
    priceEl.innerHTML = `${price.toFixed(2)} <img src="ton.svg" style="width:12px;vertical-align:middle">`;
    cell.appendChild(priceEl);

    // canvas for destroy frames (pixelated)
    const canvas = document.createElement('canvas');
    canvas.className = 'pixelated';
    // set internal canvas resolution small to preserve pixel-artiness (16x16 scaled)
    canvas.width = 16;
    canvas.height = 16;
    canvas.style.position = 'absolute';
    canvas.style.inset = '0';
    cell.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    let hits = 0;
    const totalHits = ore.hits;
    // compute evenly spaced frame indices between 0..9
    const frames = [];
    for(let i=0;i<totalHits;i++){
      const idx = Math.round(i*(9/(Math.max(1,totalHits-1))));
      frames.push(idx);
    }
    // keep loaded frames as Image objects cache
    const frameImgs = new Array(10);
    function drawFrame(idx){
      const src = `destroy/destroy_stage_${idx}.png`;
      if(frameImgs[idx]){
        ctx.clearRect(0,0,16,16);
        ctx.drawImage(frameImgs[idx],0,0,16,16);
      } else {
        const im = new Image();
        im.onload = ()=>{ frameImgs[idx]=im; ctx.clearRect(0,0,16,16); ctx.drawImage(im,0,0,16,16); };
        im.onerror = ()=>{ /* ignore */ };
        im.src = src;
      }
    }

    // click handler
    cell.onclick = () => {
      if(cell.classList.contains('cooldown')) return;
      // if first hit, ensure balance >= price (player must be able to pay)
      if(hits === 0 && balance < price){
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ª–æ–º–∫–∏ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞.');
        return;
      }
      // show frame for this hit
      const frameIdx = frames[Math.min(hits, frames.length-1)];
      drawFrame(frameIdx);
      hits++;
      if(hits >= totalHits){
        // charge price once, reward gift
        balance -= price;
        updateBalanceUI();
        transactions.unshift(`–õ–æ–º–∞–Ω–∏–µ –±–ª–æ–∫–∞ -${price.toFixed(2)} TON`);
        // reward
        const gift = getGiftByPrice(price);
        inventory.push(gift);
        // animate to inventory
        flyGift(gift, cell);
        // update stats
        brokenBlocks++;
        updateBrokenUI();
        updateTransactionsUI();
        // cooldown & respawn
        cell.classList.add('cooldown');
        // show respawn timer (shortened for demo)
        const respawnMs = (60 + Math.random()*1740)*1000;
        const minutes = Math.round(respawnMs/60000);
        cell.innerHTML = `<div style="position:absolute;top:6px;left:6px;font-size:0.7rem;color:#ddd">${minutes}m</div>`;
        setTimeout(()=>{ spawnBlock(cell,index); }, respawnMs);
      }
    };
  }

  function generateMineGrid(){
    const grid = document.getElementById('mineGrid');
    grid.innerHTML = '';
    for(let i=0;i<16;i++){
      const cell = document.createElement('div');
      spawnBlock(cell, i);
      grid.appendChild(cell);
    }
  }

  /* -------------------------
     FLY GIFT (smooth, no teleport)
     - Use Web Animations API translating by dx/dy
     - Lottie animation uses blob URL from animationMap if available; otherwise try emoji/<name>.json path
     - destroy only after animation completes
     -------------------------*/
  function flyGift(gift, fromCell){
    const rect = fromCell.getBoundingClientRect();
    const fly = document.createElement('div');
    fly.className = 'flying';
    fly.style.left = (rect.left + rect.width/2 - 30) + 'px';
    fly.style.top  = (rect.top + rect.height/2 - 30) + 'px';
    document.body.appendChild(fly);

    // choose lottie path blob if preloaded
    const lottiePath = animationMap[gift.name] || `emoji/${gift.name}.json`;
    const anim = lottie.loadAnimation({
      container: fly,
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: lottiePath
    });

    const invBtnRect = document.getElementById('tab-inventory').getBoundingClientRect();
    const targetX = invBtnRect.left + invBtnRect.width/2 - 30;
    const targetY = invBtnRect.top + invBtnRect.height/2 - 30;
    const dx = targetX - (rect.left + rect.width/2 - 30);
    const dy = targetY - (rect.top + rect.height/2 - 30);

    // animate
    const wa = fly.animate([
      { transform: 'translate(0,0)' },
      { transform: `translate(${dx}px, ${dy}px)` }
    ], { duration: 1500, easing: 'cubic-bezier(.2,.8,.2,1)' });

    wa.onfinish = () => {
      try{ anim.stop(); anim.destroy(); }catch(e){}
      fly.remove();
      // add a tiny bounce in inventory (visual)
      // nothing else needed
    };
    // fallback: remove after duration
    setTimeout(()=>{ if(document.body.contains(fly)){ try{ anim.stop(); anim.destroy(); }catch(e){} fly.remove(); } }, 1700);
  }

  /* -------------------------
     Inventory UI
     -------------------------*/
  function renderInventory(){
    const list = document.getElementById('inventoryList');
    list.innerHTML = '';
    inventory.forEach((gift, idx) => {
      const item = document.createElement('div');
      item.className = 'gift-item';
      const top = document.createElement('div'); top.className = 'gift-top';
      const prev = document.createElement('div'); prev.className = 'gift-preview';

      // if we have blob URL from preload, show animation
      if(animationMap[gift.name]){
        try{
          lottie.loadAnimation({ container: prev, renderer: 'svg', loop: true, autoplay: true, path: animationMap[gift.name] });
        } catch(e){
          prev.textContent = gift.name;
        }
      } else {
        // fallback text
        prev.textContent = gift.name;
      }

      const info = document.createElement('div'); info.className = 'gift-info';
      const name = document.createElement('div'); name.className = 'gift-name'; name.textContent = gift.name;
      const price = document.createElement('div'); price.className = 'gift-price'; price.innerHTML = `–¶–µ–Ω–∞: ${gift.price.toFixed(2)} <img src="ton.svg" style="width:12px;vertical-align:middle">`;
      info.appendChild(name); info.appendChild(price);

      top.appendChild(prev); top.appendChild(info);

      const actions = document.createElement('div'); actions.className = 'gift-actions';
      const sell = document.createElement('button'); sell.className='btn primary'; sell.textContent = '–ü—Ä–æ–¥–∞—Ç—å';
      sell.onclick = ()=>{
        balance += gift.price;
        updateBalanceUI();
        transactions.unshift(`–ü—Ä–æ–¥–∞–∂–∞: ${gift.name} +${gift.price.toFixed(2)} TON`);
        inventory.splice(idx,1);
        renderInventory();
        updateTransactionsUI();
      };
      const withdraw = document.createElement('button'); withdraw.className='btn secondary'; withdraw.textContent='–í—ã–≤–µ—Å—Ç–∏';
      withdraw.onclick = ()=>{
        // stub
        inventory.splice(idx,1);
        renderInventory();
        transactions.unshift(`–í—ã–≤–æ–¥: ${gift.name}`);
        updateTransactionsUI();
        alert('–ó–∞–ø—Ä–æ—à–µ–Ω –≤—ã–≤–æ–¥. (–∑–∞–≥–ª—É—à–∫–∞)');
      };

      actions.appendChild(sell); actions.appendChild(withdraw);
      item.appendChild(top); item.appendChild(actions);
      list.appendChild(item);
    });
  }

  /* -------------------------
     PROMO & DEPOSIT
     -------------------------*/
  function redeemPromo(){
    const code = document.getElementById('promoCode').value.trim();
    if(!code){ alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'); return; }
    if(code === 'BONUS10'){
      balance += 10;
      transactions.unshift('–ü—Ä–æ–º–æ–∫–æ–¥ BONUS10: +10 TON');
      updateBalanceUI();
      updateTransactionsUI();
      alert('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: +10 TON');
    } else {
      transactions.unshift(`–ü—Ä–æ–º–æ–∫–æ–¥: –Ω–µ–≤–µ—Ä–Ω—ã–π (${code})`);
      updateTransactionsUI();
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥');
    }
  }

  function addBalancePrompt(method){
    const sumStr = prompt(`–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ ${method}:`, '100');
    const sum = sumStr ? parseFloat(sumStr) : 0;
    if(!sum || sum <= 0) return;
    // commission applied (as percent)
    let net = sum;
    if(method === 'CryptoBot') net = sum * 0.95; // 5% fee
    if(method === 'Stars') net = sum * 0.80; // 20% fee
    // apply referral bonus as percent of deposit
    const bonus = net * (refPercent / 100);
    balance += net + bonus;
    // record transaction (newest first)
    transactions.unshift(`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${method}: +${net.toFixed(2)} TON (–∫–æ–º–∏—Å—Å–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, –±–æ–Ω—É—Å ${bonus.toFixed(2)})`);
    updateBalanceUI(); updateTransactionsUI();

    // increase refPercent slightly (simulate that a referred deposit increments bonus)
    refPercent = Math.min(MAX_REF, refPercent + 0.5);
    updateRefUI();
  }

  /* -------------------------
     PRELOAD: backgrounds, ores, destroy frames, lottie jsons
     - Wait for window load before starting preload
     -------------------------*/
  window.addEventListener('load', ()=>{ startPreload(); });

  // lottie loader animation instance
  let loaderAnimationInst = null;

  function startPreload(){
    // load lottie loader animation
    try{
      loaderAnimationInst = lottie.loadAnimation({
        container: document.getElementById('loaderAnimation'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'animations/myLoader.json'
      });
    }catch(e){ /* ignore */ }

    // gather assets
    const imagePaths = [];
    // backgrounds
    Object.values(backgrounds).forEach(p => imagePaths.push(p));
    // ores
    oreTypes.forEach(o => imagePaths.push(o.img));
    // destroy frames
    for(let i=0;i<=9;i++) imagePaths.push(`destroy/destroy_stage_${i}.png`);
    // ton & icons
    imagePaths.push('ton.svg', 'icons/cryptobot.svg', 'icons/star.svg');

    // lottie files for gifts
    const lottiePaths = gifts.map(g => ({ name: g.name, path: `emoji/${g.name}.json` }));

    const total = imagePaths.length + lottiePaths.length;
    let loaded = 0;
    const progBar = document.getElementById('loaderProgressBar');

    function tick(){ loaded++; if(progBar) progBar.style.width = Math.round((loaded/total)*100) + '%'; if(loaded >= total){ // hide loader shortly after
        setTimeout(()=>{ document.getElementById('loader').classList.add('hidden'); generateMineGrid(); updateBalanceUI(); updateTransactionsUI(); updateBrokenUI(); updateRefUI(); }, 350);
      }
    }

    // preload images
    imagePaths.forEach(src=>{
      const img = new Image();
      img.onload = tick;
      img.onerror = tick;
      img.src = src;
    });

    // preload lottie JSONs (fetch) -> convert to blob URL
    lottiePaths.forEach(item=>{
      fetch(item.path).then(r=>{
        if(!r.ok) throw new Error('no');
        return r.blob();
      }).then(blob=>{
        const url = URL.createObjectURL(blob);
        animationMap[item.name] = url;
        tick();
      }).catch(()=>{ // missing file -> skip but count tick
        tick();
      });
    });

    // set initial UI values
    balance = 1000.00;
    updateBalanceUI();
    updateRefUI();
  }

  /* -------------------------
     Small fixes: ensure can't break if insufficient funds handled inside spawnBlock
     -------------------------*/

  // expose some functions to global for buttons
  window.showTab = showTab;
  window.redeemPromo = redeemPromo;
  window.addBalancePrompt = addBalancePrompt;

  </script>
</body>
</html>
